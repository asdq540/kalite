<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalite Kontrol Paneli</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
/* KURUMSAL SOFT RENK PALETİ */
:root{
  --primary:#4a86e8;     /* Soft Kurumsal Mavi */
  --primary-dark:#093e72; /* Başlıklar için koyu (Eski thead rengi) */
  --bg:#f8f9fa;          /* Açık Gri Zemin */
  --card:#ffffff;        /* Beyaz Kart Arkaplanı */
  --thead:#3d72b2;       /* Soft Koyu Mavi Tablo Başlığı */
  --soft1:#f0f6ff;       /* Tablo Tek Sayı Satır (Çok Açık Mavi) */
  --soft2:#e9ecef;       /* Tablo Çift Sayı Satır (Çok Açık Gri) */
  --border:#dee2e6;      /* Genel Kenarlık Rengi */
  --shadow:rgba(0,0,0,0.04); /* Hafif Gölge */
}
body{
  background:var(--bg);
  font-family: "Segoe UI", sans-serif;
  padding:20px;
}
.login-container{
  max-width:420px;
  margin:90px auto;
  padding:30px;
  background:var(--card);
  border-radius:12px;
  box-shadow:0 8px 30px var(--shadow);
  border:1px solid var(--border);
}
.login-container h3{ color:var(--primary-dark); font-weight:600; }
#mainPage{ display:none; }
h1.section-title{ color:var(--primary-dark); font-weight:700; margin-bottom:16px; }

/* KART VE TABLO KAPSAYICISI */
.table-card{
  background:var(--card);
  padding:12px;
  border-radius:12px; 
  box-shadow:0 6px 20px var(--shadow); 
  margin-bottom:28px;
  border:1px solid var(--border);
}

/* TABLO STİLİ */
.table{ border-collapse: separate; border-spacing: 0; }
.table thead{ background:var(--thead) !important; color:#fff; }
.table th, .table td{ 
    padding:12px !important; 
    font-size:14px; 
    text-align:center; 
    border:1px solid var(--border);
    word-wrap: break-word; 
    max-width: 150px; 
}
.table tbody tr:nth-child(odd){ background:var(--soft1); }
.table tbody tr:nth-child(even){ background:var(--soft2); }
.table-responsive { 
    border-radius: 12px; 
    overflow-x: auto; 
    border: 1px solid var(--border);
}
.table thead tr:first-child th:first-child { border-top-left-radius: 11px; }
.table thead tr:first-child th:last-child { border-top-right-radius: 11px; }

/* ARAMA VE GİRİŞ ALANLARI */
.search-input{ 
    margin-bottom:12px; 
    border-radius:8px; 
    padding:8px 12px; 
    border:1px solid var(--border);
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
}
.search-input:focus {
    border-color: var(--primary); 
    box-shadow: 0 0 0 0.25rem rgba(74, 134, 232, 0.25); 
}
.form-control.search-input {
    height: calc(1.5em + 1rem + 2px); 
}

/* BUTONLAR */
.btn-primary {
    background-color: var(--primary);
    border-color: var(--primary);
}
.btn-primary:hover {
    background-color: #3b73c4; 
    border-color: #3b73c4;
}
.btn-outline-primary {
    color: var(--primary);
    border-color: var(--primary);
}
.btn-outline-primary:hover {
    background-color: var(--primary);
    color: #fff;
}


/* DİĞER KOMPONENTLER */
.pagination { justify-content:center; margin-top:12px; flex-wrap: wrap; }
.page-link{ cursor:pointer; }
img.thumb{
  width:68px;
  height:56px;
  object-fit:cover;
  border-radius:6px;
  box-shadow:0 2px 8px rgba(0,0,0,0.12);
  cursor:pointer;
  transition:transform .12s;
    max-width: 100%;
    height: auto;
}
img.thumb:hover{ transform:scale(1.06); }
.modal-img-wrap{
  width:100%;
  height:80vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#000;
  overflow:hidden;
  position:relative;
}
.modal-img-wrap img{
  max-width:100%; 
  max-height:100%; 
  object-fit:contain;
  transform-origin:center center;
  cursor:grab;
  user-select:none;
}
.modal-footer .small-note { margin-right:auto; color:#666; font-size:13px; }
.fadeWrapper{ transition: opacity 0.3s ease; }
.fadeIn{ opacity:1; }
.fadeOut{ opacity:0; }

@media (max-width: 576px) {
  .table th, .table td { font-size: 12px; padding: 6px !important; white-space: nowrap; }
  .pagination { flex-wrap: wrap; }
  .pagination .page-item { margin-bottom: 4px; }
  .pagination .page-link { padding: 4px 8px; font-size: 12px; }
  .table-responsive { 
    overflow-x: auto; 
    width: 100%;
    display: block; 
}
}
</style>
</head>
<body>

<div id="loginPage" class="login-container">
  <h3 class="text-center mb-3">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input id="username" class="form-control" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input id="password" type="password" class="form-control" placeholder="Şifrenizi girin">
  </div>
  <div class="d-grid gap-2">
    <button onclick="login()" class="btn btn-primary">Giriş Yap</button>
  </div>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<div id="mainPage" class="container">
  <h1 class="section-title">Kalite Veri Listesi</h1>

  <div class="table-card">
    <div class="d-flex mb-3 justify-content-center gap-2">
      <button id="btnData" class="btn btn-primary">Veri Tablosu</button>
      <button id="btnPhoto" class="btn btn-outline-primary">Fotoğraf Tablosu</button>
    </div>

        <div id="dataTableWrapper" class="fadeWrapper fadeIn">
      <div class="d-flex align-items-center mb-2">
        <input id="searchInput1" type="date" class="search-input form-control flex-grow-1" placeholder="Veri tablosunda ara..."> 
        <button class="btn btn-outline-danger ms-3" onclick="logout()">Çıkış Yap</button>
      </div>
      <div class="table-responsive">
        <table id="dataTable" class="table table-hover align-middle"><thead></thead><tbody></tbody></table>
      </div>
      <nav><ul id="pagination1" class="pagination"></ul></nav>
    </div>

        <div id="photoTableWrapper" class="fadeWrapper" style="display:none;">
      <div class="d-flex align-items-center mb-2">
        <input id="searchInput2" type="date" class="search-input form-control flex-grow-1" placeholder="Fotoğraf tablosunda ara...">
        <div class="ms-3 text-muted small">F sütunu fotoğraflar</div>
      </div>
      <div class="table-responsive">
        <table id="photoTable" class="table table-hover align-middle"><thead></thead><tbody></tbody></table>
      </div>
      <nav><ul id="pagination2" class="pagination"></ul></nav>
    </div>
  </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-0">
        <div class="modal-img-wrap" id="modalWrap"><img id="modalImage" src="" alt="Büyütülmüş fotoğraf"></div>
        </div>
      <div class="modal-footer">
        <div class="small-note">Fare tekeri ile zoom, sürükleyerek taşıyın</div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const BACKEND_URL="https://kaliteform.onrender.com";
const sheetUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";
const PAGE_SIZE=10;

/* --- AUTH --- */
function login(){
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value.trim();
  const err=document.getElementById('errorMsg'); err.textContent='';
  fetch(BACKEND_URL+'/login',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u,password:p})})
  .then(r=>r.json()).then(res=>{
    if(res&&res.success){ localStorage.setItem('loggedIn','true'); showMain(); }
    else err.textContent='Kullanıcı adı veya şifre hatalı!';
  }).catch(()=>{err.textContent='Sunucuya ulaşılamadı!';});
}

function logout(){localStorage.removeItem('loggedIn'); document.getElementById('loginPage').style.display='block'; document.getElementById('mainPage').style.display='none'; document.getElementById('username').value=''; document.getElementById('password').value='';}
function showMain(){document.getElementById('loginPage').style.display='none'; document.getElementById('mainPage').style.display='block'; loadCsvAndInit();}
window.addEventListener('load',()=>{if(localStorage.getItem('loggedIn')==='true'){showMain();}});

/* --- CSV LOAD --- */
let dataRows=[], photoRows=[], headerRow=[];
function loadCsvAndInit(){
  fetch(sheetUrl).then(res=>res.text()).then(text=>{
    const parsed=Papa.parse(text,{header:false}).data||[];
    if(parsed.length===0){console.warn('CSV boş'); return;}
    headerRow=parsed[0]; const body=parsed.slice(1);
    dataRows=body.map(r=>r.slice(9,17));
    photoRows=body.map(r=>r.slice(0,7));

    // OTOMATİK TARİH ATAMA VE FİLTRELEME
    function getCurrentDateISO() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    const todayISO = getCurrentDateISO();
    const searchInput1 = document.getElementById('searchInput1');
    const searchInput2 = document.getElementById('searchInput2');
    
    searchInput1.value = todayISO;
    searchInput2.value = todayISO;
    
    // Otomatik filtrelemeyi tetikle
    searchInput1.dispatchEvent(new Event('input'));

    createTable({tableId:'dataTable', headers: headerRow.slice(9,17), rows: dataRows, searchId:'searchInput1', paginationId:'pagination1', pageSize:PAGE_SIZE, isPhoto:false});
    createTable({tableId:'photoTable', headers: headerRow.slice(0,7), rows: photoRows, searchId:'searchInput2', paginationId:'pagination2', pageSize:PAGE_SIZE, isPhoto:true});
  }).catch(err=>console.error(err));
}

/* --- GENERIC TABLE --- */
function createTable({tableId, headers, rows, searchId, paginationId, pageSize=10, isPhoto=false}){
  const table=document.getElementById(tableId), thead=table.querySelector('thead'), tbody=table.querySelector('tbody');
  const searchInput=document.getElementById(searchId), pagination=document.getElementById(paginationId);
  const originalRows=rows.slice(); let filteredRows=rows.slice(); let currentPage=1;

  function renderHead(){
    thead.innerHTML='';
    const tr=document.createElement('tr');
    headers.forEach(h=>{
      const th=document.createElement('th');
      th.textContent=h||'';
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function renderPage(){
    tbody.innerHTML='';
    const total=filteredRows.length;
    const totalPages=Math.max(1, Math.ceil(total/pageSize));
    if(currentPage>totalPages) currentPage=totalPages;
    const start=(currentPage-1)*pageSize;
    const pageSlice=filteredRows.slice(start,start+pageSize);

    pageSlice.forEach(row=>{
      const tr=document.createElement('tr');
      row.forEach((cell,idx)=>{
        const td=document.createElement('td');
        if(isPhoto && idx===5 && cell){
          const img=document.createElement('img');
          img.className='thumb';
          img.loading='lazy';
          img.alt='foto';
          img.src=cell;
          img.addEventListener('click',()=>openImageModal(cell));
          td.appendChild(img);
        }else td.textContent=cell;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    renderPagination();
  }

  function renderPagination(){
    pagination.innerHTML='';
    const totalPages=Math.max(1, Math.ceil(filteredRows.length/pageSize));

    const liPrev=document.createElement('li'); liPrev.className='page-item '+(currentPage===1?'disabled':'');
    const btnPrev=document.createElement('button'); btnPrev.className='page-link'; btnPrev.textContent='Geri';
    btnPrev.addEventListener('click',(e)=>{e.preventDefault(); if(currentPage>1) currentPage--; renderPage();});
    liPrev.appendChild(btnPrev); pagination.appendChild(liPrev);

    const liNext=document.createElement('li'); liNext.className='page-item '+(currentPage===totalPages?'disabled':'');
    const btnNext=document.createElement('button'); btnNext.className='page-link'; btnNext.textContent='İleri';
    btnNext.addEventListener('click',(e)=>{e.preventDefault(); if(currentPage<totalPages) currentPage++; renderPage();});
    liNext.appendChild(btnNext); pagination.appendChild(liNext);
  }

  searchInput.addEventListener('input', ()=>{
    const term=(searchInput.value||'').toLowerCase();
    filteredRows = originalRows.filter(r=>r.join(' ').toLowerCase().includes(term));
    currentPage=1;
    renderPage();
  });

  renderHead();
  renderPage();
}

/* --- TABLE SWITCH --- */
const btnData=document.getElementById('btnData'), btnPhoto=document.getElementById('btnPhoto');
const dataWrapper=document.getElementById('dataTableWrapper'), photoWrapper=document.getElementById('photoTableWrapper');
function showDataTable(){btnData.classList.replace('btn-outline-primary','btn-primary'); btnPhoto.classList.replace('btn-primary','btn-outline-primary'); photoWrapper.classList.add('fadeOut'); dataWrapper.style.display='block'; dataWrapper.classList.remove('fadeOut'); dataWrapper.classList.add('fadeIn'); setTimeout(()=>photoWrapper.style.display='none',300);}
function showPhotoTable(){btnPhoto.classList.replace('btn-outline-primary','btn-primary'); btnData.classList.replace('btn-primary','btn-outline-primary'); dataWrapper.classList.add('fadeOut'); photoWrapper.style.display='block'; photoWrapper.classList.remove('fadeOut'); photoWrapper.classList.add('fadeIn'); setTimeout(()=>dataWrapper.style.display='none',300);}
btnData.addEventListener('click', showDataTable); btnPhoto.addEventListener('click', showPhotoTable);

/* --- MODAL ZOOM/DRAG --- */
const modalEl=document.getElementById('imageModal'); const modalImage=document.getElementById('modalImage'); const modalWrap=document.getElementById('modalWrap'); let bsModal=null;
let scale=1, translateX=0, translateY=0, isDragging=false, dragStartX=0, dragStartY=0, imgStartX=0, imgStartY=0;
function resetTransform(){scale=1; translateX=0; translateY=0; applyTransform();}
function applyTransform(){modalImage.style.transform=`translate(${translateX}px,${translateY}px) scale(${scale})`;}
function openImageModal(src){modalImage.src=src; resetTransform(); if(!bsModal) bsModal=new bootstrap.Modal(modalEl); bsModal.show();}

/* ZOOM */
modalWrap.addEventListener('wheel',function(e){if(e.target && e.target.tagName==='IMG'){e.preventDefault(); const delta=-e.deltaY; const zoomFactor=delta>0?1.08:0.92; const newScale=Math.min(6,Math.max(0.5,scale*zoomFactor)); const rect=modalImage.getBoundingClientRect(); const mx=e.clientX-rect.left; const my=e.clientY-rect.top; const dx=(mx-rect.width/2); const dy=(my-rect.height/2); translateX=translateX-dx*(newScale/scale-1); translateY=translateY-dy*(newScale/scale-1); scale=newScale; applyTransform();}},{passive:false});
modalImage.addEventListener('pointerdown',function(e){if(e.button!==0)return; isDragging=true; modalImage.setPointerCapture(e.pointerId); modalImage.style.cursor='grabbing'; dragStartX=e.clientX; dragStartY=e.clientY; imgStartX=translateX; imgStartY=translateY;});
modalImage.addEventListener('pointermove',function(e){if(!isDragging)return; const dx=e.clientX-dragStartX; const dy=e.clientY-dragStartY; translateX=imgStartX+dx; translateY=imgStartY+dy; applyTransform();});
modalImage.addEventListener('pointerup',function(e){isDragging=false; modalImage.releasePointerCapture(e.pointerId); modalImage.style.cursor='grab';});
modalEl.addEventListener('hidden.bs.modal',function(){modalImage.src=''; resetTransform();});
modalImage.addEventListener('load',resetTransform);
</script>
</body>
</html>
