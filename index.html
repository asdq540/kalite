<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kalite Kontrol Paneli</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
:root {
  --primary: #0d6efd;
  --primary-dark: #0b5ed7;
  --background: #f1f3f5;
  --card-bg: #ffffff;
  --table-header: #093e72;
}

body { background: var(--background); padding: 20px; font-family: "Segoe UI", sans-serif; }

/* Login Kutusu */
.login-container {
  max-width: 420px; margin: 120px auto; padding: 35px;
  background: var(--card-bg); border-radius: 14px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.12); border: 1px solid #dee2e6;
}
.login-container h3 { font-weight: 600; color: #093e72; }

/* Ana Panel */
#mainPage h1 { color: #093e72; font-weight: 700; margin-bottom: 25px; }

#searchInput { margin-bottom: 20px; border-radius: 10px; padding: 10px 15px; border: 1px solid #bfc4c9; }

.table-container {
  overflow-x: auto; background: white; padding: 10px;
  border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);
}

.table thead { background: var(--table-header) !important; color: white; }
.table th, .table td { padding: 10px !important; border: 1px solid #dee2e6 !important; }
.table tbody tr:hover { background: #e9f3ff !important; transform: scale(1.01); transition: 0.1s; }

.btn-outline-danger { margin-top: 20px; font-weight: 600; border-radius: 10px; }
.hidden { display: none; }

/* Fotoğraf tablosu özel stiller */
.photo-name { font-weight: 600; color: #093e72; background: #e0f7fa; border-radius: 6px; text-align: center; display: block; padding: 2px 5px;}
.photo-cell { background: #f1f8e9; text-align: center; }

.tab-button { margin-right:10px; }
</style>
</head>
<body>

<!-- Login -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-4">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input type="text" id="username" class="form-control" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input type="password" id="password" class="form-control" placeholder="Şifrenizi girin">
  </div>
  <button class="btn btn-primary w-100" onclick="login()">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- Ana Panel -->
<div id="mainPage" class="hidden container">
  <h1>Kalite Kontrol Paneli</h1>

  <!-- Sekmeler -->
  <div class="mb-3">
    <button class="btn btn-primary tab-button" onclick="showTab('data')">Veri Listesi</button>
    <button class="btn btn-secondary tab-button" onclick="showTab('photo')">Fotoğraflar</button>
  </div>

  <!-- Arama -->
  <input type="text" id="searchInput" class="form-control mb-3" placeholder="Tabloda arayın...">

  <!-- Veri Tablosu -->
  <div id="dataTab" class="table-container">
    <table class="table table-striped table-hover" id="dataTable">
      <thead class="table-dark"></thead>
      <tbody></tbody>
    </table>
    <nav>
      <ul class="pagination" id="dataPagination"></ul>
    </nav>
  </div>

  <!-- Fotoğraf Tablosu -->
  <div id="photoTab" class="table-container hidden">
    <table class="table table-striped table-hover" id="photoTable">
      <thead class="table-dark"></thead>
      <tbody></tbody>
    </table>
    <nav>
      <ul class="pagination" id="photoPagination"></ul>
    </nav>
  </div>

  <button class="btn btn-outline-danger mt-3" onclick="logout()">Çıkış Yap</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";
const pageSize = 20;

// Sekme gösterimi
function showTab(tab){
  document.getElementById('dataTab').classList.add('hidden');
  document.getElementById('photoTab').classList.add('hidden');
  if(tab==='data') document.getElementById('dataTab').classList.remove('hidden');
  else document.getElementById('photoTab').classList.remove('hidden');
}

// Giriş
function login(){
  const username=document.getElementById("username").value.trim();
  const password=document.getElementById("password").value.trim();
  const errorMsg=document.getElementById("errorMsg");

  fetch(BACKEND_URL + "/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,password})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      localStorage.setItem("loggedIn","true");
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("mainPage").classList.remove("hidden");
      loadTable();
    } else errorMsg.textContent="Kullanıcı adı veya şifre hatalı!";
  })
  .catch(()=> errorMsg.textContent="Sunucuya ulaşılamadı!");
}

// Çıkış
function logout(){
  localStorage.removeItem("loggedIn");
  document.getElementById("mainPage").classList.add("hidden");
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("username").value="";
  document.getElementById("password").value="";
  document.getElementById("errorMsg").textContent="";
}

// Sayfa yüklenince kontrol
window.onload=function(){
  if(localStorage.getItem("loggedIn")==="true"){
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("mainPage").classList.remove("hidden");
    loadTable();
  }
}

// Tablo yükleme
function loadTable(){
  fetch(sheetUrl)
    .then(res=>res.text())
    .then(csvText=>{
      const data=Papa.parse(csvText,{header:false}).data;

      // Veri tablosu J-Q sütunları (9-16)
      initPaginatedTable('dataTable','dataPagination',data,9,16);

      // Fotoğraf tablosu A-G sütunları (0-6)
      initPaginatedTable('photoTable','photoPagination',data,0,6,true);
    });
}

// Sayfalı tablo oluşturma
function initPaginatedTable(tableId,paginationId,data,startCol,endCol,isPhoto=false){
  const table=document.getElementById(tableId);
  const tbody=table.querySelector('tbody');
  const thead=table.querySelector('thead');
  thead.innerHTML='';
  tbody.innerHTML='';

  // Başlık
  const headerRow=document.createElement('tr');
  data[0].slice(startCol,endCol+1).forEach(thText=>{
    const th=document.createElement('th'); th.textContent=thText; headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  let currentPage=1;
  const totalPages=Math.ceil(data.length/pageSize);

  function renderPage(page){
    tbody.innerHTML='';
    const start=(page-1)*pageSize+1;
    const end=Math.min(start+pageSize-1,data.length-1);

    for(let i=start;i<=end;i++){
      const tr=document.createElement('tr');
      data[i].slice(startCol,endCol+1).forEach((cell,idx)=>{
        const td=document.createElement('td');
        if(isPhoto && idx===0) td.innerHTML=`<span class="photo-name">${cell}</span>`;
        else if(isPhoto && idx===5 && cell) td.innerHTML=`<button class="btn btn-sm btn-primary" onclick="window.open('${cell}','_blank')">Foto</button>`;
        else if(isPhoto) td.className='photo-cell', td.textContent=cell;
        else td.textContent=cell;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    // Pagination
    const pagination=document.getElementById(paginationId);
    pagination.innerHTML='';
    for(let p=1;p<=totalPages;p++){
      const li=document.createElement('li');
      li.className='page-item '+(p===page?'active':'');
      const a=document.createElement('a');
      a.className='page-link';
      a.href='#';
      a.textContent=p;
      a.onclick=function(e){ e.preventDefault(); renderPage(p); return false; }
      li.appendChild(a); pagination.appendChild(li);
    }
  }

  renderPage(currentPage);

  // Arama
  const searchInput=document.getElementById("searchInput");
  searchInput.addEventListener('keyup',()=>{
    const filter=searchInput.value.toLowerCase();
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.style.display=tr.textContent.toLowerCase().includes(filter)?'':'none';
    });
  });
}
</script>
</body>
</html>
