<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalite Kontrol Paneli — Modern</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
/* --- SENİN MEVCUT CSS'İN --- */
:root{--primary:#9b59b6;--bg:#f6f8fa;--card:#ffffff;--thead:#8e44ad;--row1:#ffffff;--row2:#f3f4f6;--border:#d4d7dc;--shadow:0 4px 18px rgba(0,0,0,0.08)}
body{background:var(--bg);font-family:"Segoe UI",sans-serif;padding:20px}
/* Tüm CSS’niz buraya kopyalanabilir (önceki kod) */
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-container advanced-login">
  <div class="login-header text-center mb-4">
    <h2 class="login-title">Kalite Kontrol Paneli</h2>
    <p class="login-subtitle">Güvenli Giriş</p>
  </div>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input id="username" class="form-control login-input" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input id="password" type="password" class="form-control login-input" placeholder="Şifrenizi girin">
  </div>
  <div class="d-grid">
    <button id="loginBtn" class="btn login-btn">Giriş Yap</button>
  </div>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- MAIN -->
<div id="mainPage" class="container-fluid" style="display:none">
  <div class="d-flex gap-2 mb-3 align-items-center">
    <button id="btnData" class="tab-btn active">Veri Tablosu</button>
    <button id="btnPhoto" class="tab-btn">Fotoğraflar</button>
    <button id="btnChart" class="tab-btn">Grafik</button>
    <button id="logoutBtn" class="btn btn-outline-secondary ms-auto">Çıkış</button>
  </div>

  <!-- DATA -->
  <div id="dataTableWrapper">
    <div class="table-card">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="section-title mb-0">Veri Tablosu</h4>
        <div class="text-muted small">Satır: <span id="dataCount">0</span></div>
      </div>
      <input id="searchInput1" class="search-input mb-3" placeholder="Veri tablosunda ara...">
      <div class="table-responsive"><table id="dataTable" class="table"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- PHOTO -->
  <div id="photoTableWrapper" style="display:none">
    <div class="table-card">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="section-title mb-0">Fotoğraf Tablosu</h4>
        <div class="text-muted small">Satır: <span id="photoCount">0</span></div>
      </div>
      <input id="searchInput2" class="search-input mb-3" placeholder="Fotoğraf tablosunda ara...">
      <div class="table-responsive"><table id="photoTable" class="table"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>
</div>

<div id="editModalContainer"></div>
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content"><div class="modal-body p-0"><div style="background:#000;display:flex;align-items:center;justify-content:center;"><img id="modalImage" style="max-width:100%;max-height:80vh;"/></div></div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const BACKEND_BASE = ''; // same origin
const PAGE_SIZE = 10;

let dataHeader = [], dataRows = [], photoHeader = [], photoRows = [], fullRows = [];

// login
async function login(){
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    const err = document.getElementById('errorMsg');
    err.textContent='';

    if(!u||!p){ err.textContent='Kullanıcı adı ve şifre boş olamaz.'; return; }

    try{
        const res = await fetch(BACKEND_BASE + '/login',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username:u,password:p})
        });
        const data = await res.json();
        if(res.ok && data.success){
            localStorage.setItem('loggedIn','true');
            showMain();
        }else{
            err.textContent = data?.message || 'Giriş başarısız.';
        }
    }catch(e){
        err.textContent = 'Sunucuya ulaşılamadı veya hatalı.';
    }
}

function logout(){
    localStorage.removeItem('loggedIn');
    location.reload();
}

function showMain(){
    document.getElementById('loginPage').style.display='none';
    document.getElementById('mainPage').style.display='block';
    loadDataFromBackend();
}

// load data
async function loadDataFromBackend(){
    try{
        const res = await fetch(BACKEND_BASE + '/api/get');
        const json = await res.json();

        dataHeader = json.dataHeader || [];
        dataRows = json.dataRows || [];
        photoHeader = json.photoHeader || [];
        photoRows = json.photoRows || [];

        // fullRows sadece backend’den gelen tüm satırlar (header dahil değil)
        fullRows = [];
        const maxLen = Math.max(dataRows.length, photoRows.length);
        for(let i=0;i<maxLen;i++){
            fullRows[i] = (photoRows[i] || []).concat(Array(9).fill('')).concat(dataRows[i] || []);
        }

        document.getElementById('dataCount').textContent = dataRows.length;
        document.getElementById('photoCount').textContent = photoRows.length;

        createEditableTable('dataTable', dataHeader, dataRows, 'searchInput1', 'pagination1');
        createEditableTable('photoTable', photoHeader, photoRows, 'searchInput2', 'pagination2', true);
    }catch(e){
        console.error('loadDataFromBackend error', e);
    }
}

// editable table
function createEditableTable(tableId, headers, rows, searchId, paginationId, isPhoto=false){
    const table = document.getElementById(tableId);
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const search = document.getElementById(searchId);

    // header
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    headers.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h || '';
        tr.appendChild(th);
    });
    const actionTh = document.createElement('th');
    actionTh.textContent='İşlemler';
    tr.appendChild(actionTh);
    thead.appendChild(tr);

    // rows
    tbody.innerHTML = '';
    rows.forEach((row,rowIndex)=>{
        const tr = document.createElement('tr');
        row.forEach((cell,colIndex)=>{
            const td = document.createElement('td');
            if(isPhoto && colIndex===5 && cell){
                const img = document.createElement('img');
                img.src = cell;
                img.className='thumb';
                img.alt='foto';
                img.addEventListener('click', ()=> openImage(cell));
                td.appendChild(img);
            }else td.textContent = cell ?? '';

            td.addEventListener('dblclick', ()=> activateInline(td, tableId, rowIndex, colIndex));
            tr.appendChild(td);
        });

        // action column
        const actionTd = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.className='btn btn-sm btn-outline-primary me-2';
        editBtn.textContent='Düzenle';
        editBtn.addEventListener('click', ()=> openEditModal(tableId, rowIndex));
        actionTd.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.className='btn btn-sm btn-outline-danger';
        delBtn.textContent='Sil';
        delBtn.addEventListener('click', ()=> deleteRow(tableId, rowIndex));
        actionTd.appendChild(delBtn);

        tr.appendChild(actionTd);
        tbody.appendChild(tr);
    });

    // search
    if(search){
        search.oninput = ()=>{
            const term = (search.value||'').toLowerCase();
            const trs = tbody.querySelectorAll('tr');
            trs.forEach(r=>{
                const text = r.innerText.toLowerCase();
                r.style.display = text.includes(term) ? '' : 'none';
            });
        };
    }
}

// inline edit
function activateInline(td, tableId, rowIndex, colIndex){
    const previous = td.textContent;
    td.innerHTML = `<input class="form-control form-control-sm" value="${previous}">`;
    const input = td.querySelector('input');
    input.focus();

    function cancel(){ td.textContent = previous; }
    input.addEventListener('keydown', async (e)=>{
        if(e.key==='Enter'){
            const val = input.value.trim();
            td.textContent = val;
            const rowNum = rowIndex + 2; // Google Sheet satır numarası
            let absoluteCol = tableId==='dataTable'? colIndex+9 : colIndex;
            try{
                await fetch(BACKEND_BASE + '/api/duzenle',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({
                        row: rowNum,
                        yeni: { 
                            // tüm alanları dolu göndermek gerekiyor backend update
                            tarih: fullRows[rowIndex][0],
                            vardiya: fullRows[rowIndex][1],
                            hat: fullRows[rowIndex][2],
                            aciklama: fullRows[rowIndex][3],
                            personel: fullRows[rowIndex][4],
                            foto_url: fullRows[rowIndex][5],
                            kalitePersoneli: fullRows[rowIndex][6],
                            [tableId==='dataTable'? dataHeader[colIndex]: photoHeader[colIndex]]: val
                        }
                    })
                });
                loadDataFromBackend();
            }catch(err){ console.error(err); }
        }
        if(e.key==='Escape') cancel();
    });
    input.addEventListener('blur', ()=> td.textContent = previous);
}

// modal edit
function openEditModal(tableId, rowIndex){
    // TODO: benzer şekilde modal edit açıp backend’e /api/duzenle gönder
}

// delete
async function deleteRow(tableId,rowIndex){
    if(!confirm('Satırı silmek istediğinize emin misiniz?')) return;
    try{
        const res = await fetch(BACKEND_BASE+'/api/sil',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ row: rowIndex+2 })
        });
        if(res.ok) loadDataFromBackend();
    }catch(e){ console.error(e); }
}

// image modal
function openImage(src){
    const img = document.getElementById('modalImage');
    img.src = src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

// init
document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('logoutBtn').addEventListener('click', logout);

    document.getElementById('btnData')?.addEventListener('click', ()=>{
        document.getElementById('dataTableWrapper').style.display='block';
        document.getElementById('photoTableWrapper').style.display='none';
        document.getElementById('chartWrapper').style.display='none';
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('btnData').classList.add('active');
    });
    document.getElementById('btnPhoto')?.addEventListener('click', ()=>{
        document.getElementById('dataTableWrapper').style.display='none';
        document.getElementById('photoTableWrapper').style.display='block';
        document.getElementById('chartWrapper').style.display='none';
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('btnPhoto').classList.add('active');
    });
    document.getElementById('btnChart')?.addEventListener('click', ()=>{
        document.getElementById('dataTableWrapper').style.display='none';
        document.getElementById('photoTableWrapper').style.display='none';
        document.getElementById('chartWrapper').style.display='block';
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('btnChart').classList.add('active');
    });

    if(localStorage.getItem('loggedIn')==='true') showMain();
});
</script>

</body>
</html>
