<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kalite Kontrol Paneli</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
:root {
  --primary: #0d6efd;
  --primary-dark: #0b5ed7;
  --background: #f1f3f5;
  --card-bg: #ffffff;
  --table-header: #093e72;
  --soft-blue: #e3f2fd;
  --soft-green: #e6f4ea;
}
body {
  background: var(--background);
  font-family: "Segoe UI", sans-serif;
  padding: 20px;
}
/* Login Kutusu */
.login-container {
  max-width: 420px;
  margin: 100px auto;
  padding: 35px;
  background: var(--card-bg);
  border-radius: 14px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
  border: 1px solid #dee2e6;
}
.login-container h3 { font-weight: 600; color: #093e72; }
/* Ana Panel */
#mainPage { display: none; }
#mainPage h1 { color: #093e72; font-weight: 700; margin-bottom: 20px; }
.table-container {
  overflow-x: auto;
  background: var(--card-bg);
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  margin-bottom: 40px;
}
.table thead { background: var(--table-header); color: white; }
.table th, .table td { padding: 10px; text-align: center; }
.table tbody tr:nth-child(odd) { background: var(--soft-blue); }
.table tbody tr:nth-child(even) { background: var(--soft-green); }
.page-btn { margin: 0 3px; cursor: pointer; padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; }
.page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
img.thumb { max-height: 80px; border-radius: 6px; cursor: pointer; transition: transform 0.2s; }
img.thumb:hover { transform: scale(1.1); }
/* Arama kutuları */
.search-box { margin-bottom: 10px; border-radius: 8px; padding: 8px; border: 1px solid #bfc4c9; width: 100%; }
</style>
</head>
<body>

<!-- Login -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-4">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label>Kullanıcı Adı</label>
    <input type="text" id="username" class="form-control" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label>Şifre</label>
    <input type="password" id="password" class="form-control" placeholder="Şifrenizi girin">
  </div>
  <button class="btn btn-primary w-100" onclick="login()">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- Ana Panel -->
<div id="mainPage" class="container">

  <h1>Kalite Veri Listesi</h1>
  <input type="text" id="searchData" class="search-box" placeholder="Veri tablosunda ara...">
  <div class="table-container">
    <table class="table table-striped" id="dataTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="dataPagination" class="mb-4"></div>

  <h1>Fotoğraf Tablosu</h1>
  <input type="text" id="searchPhotos" class="search-box" placeholder="Fotoğraf tablosunda ara...">
  <div class="table-container">
    <table class="table table-striped" id="photoTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="photoPagination" class="mb-4"></div>

  <button class="btn btn-outline-danger" onclick="logout()">Çıkış Yap</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";

// Giriş
function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorMsg = document.getElementById("errorMsg");
  fetch(BACKEND_URL + "/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username,password})
  }).then(res=>res.json()).then(data=>{
    if(data.success){
      document.getElementById("loginPage").style.display="none";
      document.getElementById("mainPage").style.display="block";
      loadTables();
    } else { errorMsg.textContent="Kullanıcı adı veya şifre hatalı!"; }
  }).catch(()=>{ errorMsg.textContent="Sunucuya ulaşılamadı!"; });
}

function logout() {
  document.getElementById("loginPage").style.display="block";
  document.getElementById("mainPage").style.display="none";
  document.getElementById("username").value="";
  document.getElementById("password").value="";
  document.getElementById("errorMsg").textContent="";
}

// Tablo yükleme ve sayfalama
let dataRows=[], photoRows=[];
const rowsPerPage = 10;

function loadTables(){
  fetch(sheetUrl)
  .then(r=>r.text())
  .then(csvText=>{
    const parsed = Papa.parse(csvText,{header:false}).data;
    // Veri tablosu J-Q (9-16)
    dataRows = parsed.slice(0).map(r=>r.slice(9,17));
    photoRows = parsed.slice(0).map(r=>r.slice(0,7));
    renderTable(dataRows,"dataTable","dataPagination","searchData");
    renderTable(photoRows,"photoTable","photoPagination","searchPhotos",true);
  });
}

// Genel tablo render fonksiyonu
function renderTable(rows,tableId,paginationId,searchId,isPhoto=false){
  const table = document.getElementById(tableId);
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  const pagination = document.getElementById(paginationId);
  const searchInput = document.getElementById(searchId);
  let currentPage=1;

  // Başlık
  thead.innerHTML="";
  const trHead = document.createElement("tr");
  rows[0].forEach(h=>{
    const th=document.createElement("th"); th.textContent=h; trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  // Sayfalama ve render
  function displayPage(page){
    tbody.innerHTML="";
    const filtered = rows.slice(1).filter(r=>r.join("").toLowerCase().includes(searchInput.value.toLowerCase()));
    const totalPages = Math.ceil(filtered.length/rowsPerPage);
    const start = (page-1)*rowsPerPage;
    const pageRows = filtered.slice(start,start+rowsPerPage);

    pageRows.forEach(row=>{
      const tr=document.createElement("tr");
      row.forEach((cell,i)=>{
        const td=document.createElement("td");
        if(isPhoto && i===5){ // 6. sütun fotoğraf linki
          if(cell){
            const img=document.createElement("img");
            img.src=cell;
            img.className="thumb";
            img.onclick=()=>window.open(cell,"_blank");
            td.appendChild(img);
          } else td.textContent="";
        } else { td.textContent=cell; }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // Sayfalama
    pagination.innerHTML="";
    for(let i=1;i<=totalPages;i++){
      const btn=document.createElement("span");
      btn.textContent=i;
      btn.className="page-btn"+(i===page?" active":"");
      btn.onclick=()=>{currentPage=i; displayPage(currentPage);}
      pagination.appendChild(btn);
    }
  }

  searchInput.onkeyup=()=>displayPage(1);
  displayPage(currentPage);
}
</script>
</body>
</html>
