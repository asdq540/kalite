<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kalite Kontrol Paneli</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
:root {
  --primary: #0d6efd;
  --background: #f1f3f5;
  --card-bg: #ffffff;
  --table-header: #093e72;
}
body {
  background: var(--background);
  padding: 20px;
  font-family: "Segoe UI", sans-serif;
}
/* Login Kutusu */
.login-container {
  max-width: 420px;
  margin: 120px auto;
  padding: 35px;
  background: var(--card-bg);
  border-radius: 14px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
  border: 1px solid #dee2e6;
}
.login-container h3 { font-weight: 600; color: #093e72; }
/* Ana Panel */
#mainPage h1 { color: #093e72; font-weight: 700; margin-bottom: 25px; }
#searchInput1, #searchInput2 {
  margin-bottom: 15px;
  border-radius: 10px;
  padding: 10px 15px;
  border: 1px solid #bfc4c9;
}
.table-container {
  overflow-x: auto;
  background: white;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
  margin-bottom: 30px;
}
.table thead { background: var(--table-header) !important; color: white; }
.table th, .table td { padding: 12px !important; font-size: 14px; border: 1px solid #dee2e6; text-align:center; }
.table tbody tr:hover { background: #e9f3ff !important; }
.btn-outline-danger { margin-top: 20px; font-weight: 600; border-radius: 10px; }
.hidden { display: none; }
.pagination { margin-top: 10px; }
.page-item button { cursor: pointer; }
/* Modal için resim */
#imageModal img { width: 100%; }
img.thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor:pointer; transition: transform .15s; }
img.thumb:hover { transform: scale(1.08); }
</style>
</head>
<body>

<!-- Login -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-4">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input type="text" id="username" class="form-control" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input type="password" id="password" class="form-control" placeholder="Şifrenizi girin">
  </div>
  <button class="btn btn-primary w-100" onclick="login()">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- Ana Panel -->
<div id="mainPage" class="container hidden">
  <h1>Kalite Veri Listesi</h1>

  <!-- Veri Tablosu -->
  <input type="text" id="searchInput1" class="form-control" placeholder="Veri tablosunda arayın...">
  <div class="table-container">
    <table class="table table-striped table-hover" id="dataTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <nav>
    <ul class="pagination justify-content-center" id="pagination1"></ul>
  </nav>

  <!-- Fotoğraf Tablosu -->
  <h2>Fotoğraflar</h2>
  <input type="text" id="searchInput2" class="form-control" placeholder="Fotoğraf tablosunda arayın...">
  <div class="table-container">
    <table class="table table-striped table-hover" id="photoTable">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
  <nav>
    <ul class="pagination justify-content-center" id="pagination2"></ul>
  </nav>

  <button class="btn btn-outline-danger" onclick="logout()">Çıkış Yap</button>
</div>

<!-- Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img src="" alt="Büyütülmüş resim" id="modalImg">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";

// Giriş
function login(){
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorMsg = document.getElementById("errorMsg");

  fetch(BACKEND_URL + "/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username,password})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      localStorage.setItem("loggedIn","true");
      showMainPage();
    } else {
      errorMsg.textContent = "Kullanıcı adı veya şifre hatalı!";
    }
  })
  .catch(()=>{ errorMsg.textContent = "Sunucuya ulaşılamadı!"; });
}

// sayfa yüklemede oturum kontrol
window.onload = function(){
  if(localStorage.getItem("loggedIn") === "true"){
    showMainPage();
  }
}

function showMainPage(){
  document.getElementById("loginPage").style.display = "none";
  document.getElementById("mainPage").style.display = "block";
  loadTables();
}

function logout(){
  localStorage.removeItem("loggedIn");
  document.getElementById("loginPage").style.display = "block";
  document.getElementById("mainPage").style.display = "none";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("errorMsg").textContent = "";
}

// load csv and init tables
function loadTables(){
  fetch(sheetUrl).then(r=>r.text()).then(csvText=>{
    const data = Papa.parse(csvText, { header:false }).data || [];

    // create data table (J-Q => cols 9..16)
    const dataCols = [9,10,11,12,13,14,15,16];
    createTable("dataTable","searchInput1","pagination1", data, dataCols, 10, false);

    // create photo table (A-G => cols 0..6) - F is index 5 (photo)
    const photoCols = [0,1,2,3,4,5,6];
    createTable("photoTable","searchInput2","pagination2", data, photoCols, 10, true);
  }).catch(err=>{
    console.error("CSV load error:", err);
  });
}

/**
 * createTable:
 * - tableId: id of table element
 * - searchId: id of search input
 * - paginationId: id of pagination UL
 * - data: raw parsed CSV (array of rows)
 * - cols: array of column indexes to pick from CSV
 * - pageSize: items per page
 * - isPhoto: if true, treat column index 5 as photo column (show thumb + modal)
 */
function createTable(tableId, searchId, paginationId, data, cols, pageSize, isPhoto){
  const table = document.getElementById(tableId);
  const searchInput = document.getElementById(searchId);
  const pagination = document.getElementById(paginationId);

  // headers (from first CSV row) and rows (from remaining)
  const headers = data[0] ? cols.map(c => data[0][c] ?? "") : cols.map(()=> "");
  const rows = data.slice(1).map(r => cols.map(c => r[c] ?? ""));

  let filteredRows = rows.slice(); // starts as full set
  let currentPage = 1;

  function renderPagination(){
    pagination.innerHTML = "";
    const totalPages = Math.max(1, Math.ceil(filteredRows.length / pageSize));
    for(let i=1;i<=totalPages;i++){
      const li = document.createElement("li");
      li.className = "page-item " + (i===currentPage ? "active" : "");
      const btn = document.createElement("button");
      btn.className = "page-link";
      btn.textContent = i;
      btn.onclick = (e) => {
        e.preventDefault();
        currentPage = i;
        renderPage();
      };
      li.appendChild(btn);
      pagination.appendChild(li);
    }
  }

  function renderPage(){
    const tbody = table.querySelector("tbody");
    const thead = table.querySelector("thead");
    tbody.innerHTML = "";
    thead.innerHTML = "";

    // head
    const trHead = document.createElement("tr");
    headers.forEach(h=>{
      const th = document.createElement("th");
      th.textContent = h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    // rows on current page
    const total = filteredRows.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if(currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * pageSize;
    const pageRows = filteredRows.slice(start, start + pageSize);

    pageRows.forEach(row => {
      const tr = document.createElement("tr");
      row.forEach((cell, idx) => {
        const td = document.createElement("td");
        if(isPhoto && idx === 5 && cell){
          const img = document.createElement("img");
          img.src = cell;
          img.alt = "foto";
          img.className = "thumb";
          img.loading = "lazy";
          img.onclick = () => {
            document.getElementById("modalImg").src = cell;
            new bootstrap.Modal(document.getElementById("imageModal")).show();
          };
          td.appendChild(img);
        } else {
          td.textContent = cell;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    renderPagination();
  }

  // initial render
  renderPage();

  // search handler — uses filteredRows and re-renders
  // remove previous listeners (defensive) by cloning node
  const newInput = searchInput.cloneNode(true);
  searchInput.parentNode.replaceChild(newInput, searchInput);

  newInput.addEventListener("input", function(){
    const term = this.value.trim().toLowerCase();
    if(!term){
      filteredRows = rows.slice();
    } else {
      filteredRows = rows.filter(r => r.join(" ").toLowerCase().includes(term));
    }
    currentPage = 1;
    renderPage();
  });
}

</script>
</body>
</html>
