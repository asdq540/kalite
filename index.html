<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalite Kontrol Paneli</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
:root{
    --primary:#9b59b6;
    --bg:#f6f8fa;
    --card:#ffffff;
    --thead:#8e44ad;
    --row1:#ffffff;
    --row2:#f3f4f6;
    --border:#d4d7dc;
    --shadow:0 4px 18px rgba(0,0,0,0.08);

    /* ‚≠ê Neon ek renkler */
    --neon1:#ff00ea;
    --neon2:#00f6ff;
    --dark-bg:#0d0d0f;
}

/* ------------------------------------------------------
   üü£ GENEL TEMA
------------------------------------------------------ */
body{
    background:var(--bg);
    font-family:"Segoe UI",sans-serif;
    padding:20px;
}

.login-container{
    max-width:420px;
    margin:90px auto;
    padding:30px;
    background:var(--card);
    border-radius:14px;
    box-shadow:var(--shadow);
    border:1px solid var(--border);
}

#mainPage{display:none}

.section-title{
    color:var(--thead);
    font-weight:700;
    font-size:22px;
    margin-bottom:12px;
}

/* ------------------------------------------------------
   üü£ NEON TABLE CARD
------------------------------------------------------ */
.table-card{
    background:rgba(20,20,30,0.85);
    padding:22px;
    border-radius:14px;
    box-shadow:0 0 16px rgba(155,89,182,0.25);
    border:2px solid rgba(155,89,182,0.35);
    backdrop-filter:blur(8px);
    animation:fadeIn 0.5s ease;
    margin-bottom:20px;
}

/* ------------------------------------------------------
   üü£ TABLO BA≈ûLIƒûI - NEON GRADIENT
------------------------------------------------------ */
.table thead th{
    background: linear-gradient(135deg, var(--neon1), var(--neon2)) !important;
    color:#fff !important;
    padding:14px!important;
    font-size:15px;
    text-transform:uppercase;
    border:none!important;
    position:sticky;
    top:0;
    z-index:3;
    box-shadow:0 2px 8px rgba(0,0,0,0.4);
    text-align:center;
    letter-spacing:0.5px;
}

/* ------------------------------------------------------
   üü£ TABLO SATIRLARI - HAFƒ∞F GLOW
------------------------------------------------------ */
.table tbody tr{
    background:rgba(255,255,255,0.05);
    transition:0.25s ease;
    border-radius:10px;
}

.table tbody tr:hover{
    background:rgba(155,89,182,0.15) !important;
    transform:scale(1.02);
    box-shadow:0 0 14px rgba(155,89,182,0.45);
}

/* H√ºcreler */
.table tbody td{
    padding:12px!important;
    vertical-align:middle;
    text-align:center;
    color:#f1eaff;
    border-top:1px solid rgba(255,255,255,0.06);
    border-bottom:1px solid rgba(255,255,255,0.06);
}

/* Sol & saƒü k√∂≈üe radius */
.table tbody tr td:first-child{
    border-left:1px solid rgba(255,255,255,0.06);
    border-top-left-radius:10px;
    border-bottom-left-radius:10px;
}
.table tbody tr td:last-child{
    border-right:1px solid rgba(255,255,255,0.06);
    border-top-right-radius:10px;
    border-bottom-right-radius:10px;
}

/* ------------------------------------------------------
   üü£ NEON PAGINATION
------------------------------------------------------ */
.pagination .page-link{
    background:transparent;
    border:1px solid var(--neon2);
    color:var(--neon2);
    border-radius:10px!important;
    margin:3px;
    transition:0.25s ease;
}

.pagination .page-link:hover{
    background:var(--neon2);
    color:#000;
    box-shadow:0 0 12px var(--neon2);
    transform:scale(1.12);
}

.pagination .page-item.active .page-link{
    background:linear-gradient(90deg,var(--neon1),var(--neon2));
    border:none;
    color:#000;
    box-shadow:0 0 18px var(--neon1);
}

/* ƒ∞lk/son buton */
.pagination .page-item:first-child .page-link,
.pagination .page-item:last-child .page-link{
    border-color:var(--neon1);
    color:var(--neon1);
}
.pagination .page-item:first-child .page-link:hover,
.pagination .page-item:last-child .page-link:hover{
    background:var(--neon1);
    color:#000;
    box-shadow:0 0 12px var(--neon1);
}

/* ------------------------------------------------------
   üü£ RESƒ∞M - HAFƒ∞F NEON BORDER
------------------------------------------------------ */
img.thumb{
    width:88px;
    height:72px;
    object-fit:cover;
    border-radius:8px;
    border:2px solid rgba(155,89,182,0.4);
    transition:0.25s ease;
    cursor:pointer;
}
img.thumb:hover{
    border-color:var(--neon2);
    box-shadow:0 0 12px var(--neon2);
}

/* ------------------------------------------------------
   üü£ SEARCH INPUT
------------------------------------------------------ */
.search-input{
    border-radius:10px;
    padding:10px;
    border:2px solid rgba(155,89,182,0.4);
    background:rgba(255,255,255,0.1);
    color:#fff;
}
.search-input:focus{
    border-color:var(--neon2);
    box-shadow:0 0 10px var(--neon2);
}

/* ------------------------------------------------------
   üü£ TAB / BUTONLAR
------------------------------------------------------ */
.tab-btn{
    padding:8px 14px;
    border-radius:30px;
    font-weight:600;
    border:2px solid var(--neon1);
    background:#0d0d0f;
    color:var(--neon1);
    transition:0.25s ease;
}
.tab-btn.active{
    background:linear-gradient(90deg,var(--neon1),var(--neon2));
    color:#000;
    box-shadow:0 0 15px var(--neon1);
}

/* ------------------------------------------------------
   üü£ CHART CONTAINER
------------------------------------------------------ */
#chartContainer{
    height:520px!important;
    padding:12px;
    background:rgba(20,20,30,0.9);
    border-radius:14px;
    box-shadow:0 0 16px rgba(155,89,182,0.25);
    border:2px solid rgba(155,89,182,0.35);
}

/* ------------------------------------------------------
   üü£ RESPONSIVE
------------------------------------------------------ */
@media (max-width: 768px){
    .table thead th{
        font-size:12px !important;
        padding:10px !important;
    }
    .table tbody td{
        font-size:13px;
        padding:8px !important;
        white-space:nowrap;
    }
    img.thumb{
        width:60px;
        height:50px;
    }
}
@media (max-width: 480px){
    .table tbody td{
        font-size:12px;
        padding:6px !important;
    }
    img.thumb{
        width:50px;
        height:40px;
    }
}

/* ------------------------------------------------------
   üü£ ANƒ∞MASYON
------------------------------------------------------ */
@keyframes fadeIn{
    from { opacity:0; transform:translateY(12px); }
    to   { opacity:1; transform:translateY(0); }
}

/* PAGINATION RESPONSIVE */
.pagination-wrapper{
    display:flex;
    justify-content:center;
    overflow-x:auto;
    padding:0.5rem 0;
}
.pagination-wrapper ul{
    flex-wrap:nowrap;
}

</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-container advanced-login">
    <div class="login-header text-center mb-4">
        <h2 class="login-title">Kalite Kontrol Paneli</h2>
        <p class="login-subtitle">G√ºvenli Giri≈ü</p>
    </div>
    <div class="mb-3">
        <label class="form-label">Kullanƒ±cƒ± Adƒ±</label>
        <input id="username" class="form-control login-input" placeholder="Kullanƒ±cƒ± adƒ±nƒ±zƒ± girin" value="">
    </div>
    <div class="mb-3">
        <label class="form-label">≈ûifre</label>
        <input id="password" type="password" class="form-control login-input" placeholder="≈ûifrenizi girin" value="">
    </div>
    <div class="d-grid">
        <button id="loginBtn" class="btn login-btn">Giri≈ü Yap</button>
    </div>
    <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- MAIN -->
<div id="mainPage" class="container-fluid" style="display:none">
    <div class="d-flex gap-2 mb-3 align-items-center">
        <button id="btnData" class="tab-btn active">Veri Tablosu</button>
        <button id="btnPhoto" class="tab-btn">Fotoƒüraflar</button>
        <button id="btnChart" class="tab-btn">Grafik</button>
        <button id="logoutBtn" class="btn btn-outline-secondary ms-auto">√áƒ±kƒ±≈ü</button>
    </div>

    <!-- DATA -->
    <div id="dataTableWrapper">
        <div class="table-card">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h4 class="section-title mb-0">Veri Tablosu</h4>
                <div class="text-muted small">Satƒ±r: <span id="dataCount">0</span></div>
            </div>
            <input id="searchInput1" class="search-input mb-3" placeholder="Veri tablosunda ara...">
            <div class="table-responsive"><table id="dataTable" class="table"><thead></thead><tbody></tbody></table></div>
            <div class="pagination-wrapper"><ul id="pagination1" class="pagination"></ul></div>
        </div>
    </div>

    <!-- PHOTO -->
    <div id="photoTableWrapper" style="display:none">
        <div class="table-card">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h4 class="section-title mb-0">Fotoƒüraf Tablosu</h4>
                <div class="text-muted small">Satƒ±r: <span id="photoCount">0</span></div>
            </div>
            <input id="searchInput2" class="search-input mb-3" placeholder="Fotoƒüraf tablosunda ara...">
            <div class="table-responsive"><table id="photoTable" class="table"><thead></thead><tbody></tbody></table></div>
            <div class="pagination-wrapper"><ul id="pagination2" class="pagination"></ul></div>
        </div>
    </div>

    <!-- CHART -->
    <div id="chartWrapper" style="display:none">
        <div class="table-card">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h4 class="section-title mb-0">Tekrar Sayƒ±sƒ± Grafiƒüi</h4>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-4"><label class="form-label">Tarih (opsiyonel)</label><input type="date" id="chartDate" class="form-control"></div>
                <div class="col-md-4"><label class="form-label">Periyot</label>
                    <select id="chartPeriod" class="form-select">
                        <option value="daily">G√ºnl√ºk</option>
                        <option value="weekly">Haftalƒ±k</option>
                        <option value="monthly">Aylƒ±k</option>
                    </select>
                </div>
                <div class="col-md-4">
    <label class="form-label">Gruplama Kriteri</label>
    <select id="chartGroupBy" class="form-select">
        <option value="3">A√ßƒ±klama</option>
        <option value="4">Sorumlu Personel</option>
        <option value="1">Vardiya</option>
        <option value="2">Hat</option>
    </select>
</div>

                <div class="col-md-4 d-flex align-items-end"><button id="refreshChart" class="btn btn-outline-primary">Yenile</button></div>
            </div>
            <div id="chartContainer"><canvas id="errorChart"></canvas></div>
        </div>
    </div>
</div>

<!-- IMAGE MODAL -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <div style="background:#000;display:flex;align-items:center;justify-content:center;">
                    <img id="modalImage" style="max-width:100%;max-height:80vh;"/>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EDIT MODAL -->
<div id="editModalContainer"></div>

<!-- Offline badge -->
<div id="offlineBadge" class="d-none"><div class="badge bg-warning text-dark">Demo / Offline Mod</div></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const BACKEND_BASE = 'https://vardiya-backend.onrender.com';
const PAGE_SIZE = 20;
let headerRow = [], fullRows = [], dataRows = [], photoRows = [], errorChart = null;

// ---------------- LOGIN ----------------
async function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    const err = document.getElementById('errorMsg');
    err.textContent = '';
    if(!u||!p){ err.textContent='Kullanƒ±cƒ± adƒ± ve ≈üifre bo≈ü olamaz.'; return; }
    try{
        const res = await fetch(BACKEND_BASE + '/login',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username:u,password:p})
        });
        const data = await res.json();
        if(res.ok && data.success){
            localStorage.setItem('loggedIn','true');
            showMain();
        } else {
            err.textContent = data?.message || 'Giri≈ü ba≈üarƒ±sƒ±z.';
        }
    } catch(e){ err.textContent='Sunucuya ula≈üƒ±lamadƒ±.'; }
}

function logout(){ localStorage.removeItem('loggedIn'); location.reload(); }
function showMain(){ 
    document.getElementById('loginPage').style.display='none'; 
    document.getElementById('mainPage').style.display='block'; 
    loadDataFromBackend(); 
}

// ---------------- DATA LOAD ----------------
async function loadDataFromBackend(){
    try{
        const res = await fetch(BACKEND_BASE + '/api/get');
        const json = await res.json();

        headerRow = json.dataHeader || [];
        dataRows = json.dataRows || [];
        photoRows = json.photoRows || [];
        
        document.getElementById('dataCount').textContent = dataRows.length;
        document.getElementById('photoCount').textContent = photoRows.length;

        createEditableTable('dataTable', headerRow, dataRows, 'searchInput1', 'pagination1', false);
        createEditableTable('photoTable', json.photoHeader, photoRows, 'searchInput2', 'pagination2', true);

        renderChart();
    } catch(e){ console.error('loadDataFromBackend error', e); }
}

// ---------------- TABLE WITH PAGINATION ----------------
function createEditableTable(tableId, headers, rows, searchId, paginationId, isPhoto=false){
    const table = document.getElementById(tableId);
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const search = document.getElementById(searchId);
    const pagination = document.getElementById(paginationId);

    thead.innerHTML = '';
    const trHead = document.createElement('tr');
    headers.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h || '';
        trHead.appendChild(th);
    });
    if(isPhoto){
        const actionTh = document.createElement('th');
        actionTh.textContent = 'ƒ∞≈ülemler';
        trHead.appendChild(actionTh);
    }
    thead.appendChild(trHead);

    let filteredRows = [...rows];
    let currentPage = 1;

    function renderTable(){
        tbody.innerHTML = '';
        const start = (currentPage-1)*PAGE_SIZE;
        const pageRows = filteredRows.slice(start, start+PAGE_SIZE);

        pageRows.forEach((row,rowIndex)=>{
            const tr=document.createElement('tr');
            row.forEach((cell,colIndex)=>{
                const td=document.createElement('td');
                if(isPhoto && colIndex===5 && cell){
                    const img=document.createElement('img');
                    img.src=cell; img.className='thumb';
                    img.alt='foto';
                    img.addEventListener('click',()=>openImage(cell));
                    td.appendChild(img);
                } else td.textContent=cell||'';
                tr.appendChild(td);
            });

            if(isPhoto){
                const actionTd=document.createElement('td');
                const editBtn=document.createElement('button');
                editBtn.className='btn btn-sm btn-outline-primary me-2';
                editBtn.textContent='D√ºzenle';
                editBtn.addEventListener('click',()=>openEditModal((currentPage-1)*PAGE_SIZE + rowIndex));
                actionTd.appendChild(editBtn);

                const delBtn=document.createElement('button');
                delBtn.className='btn btn-sm btn-outline-danger';
                delBtn.textContent='Sil';
                delBtn.addEventListener('click',()=>deleteRow((currentPage-1)*PAGE_SIZE + rowIndex));
                actionTd.appendChild(delBtn);

                tr.appendChild(actionTd);
            }

            tbody.appendChild(tr);
        });

        renderPagination();
    }

   function renderPagination(){
    if(!pagination) return;
    pagination.innerHTML = '';
    const totalPages = Math.ceil(filteredRows.length / PAGE_SIZE);
    const maxPagesToShow = 5; // Maksimum g√∂sterilecek sayfa numarasƒ±
    let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow/2));
    let endPage = startPage + maxPagesToShow - 1;

    if(endPage > totalPages){
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }

    // Back button
    const prevLi = document.createElement('li');
    prevLi.className = 'page-item ' + (currentPage===1?'disabled':'');
    const prevA = document.createElement('a');
    prevA.className = 'page-link';
    prevA.href='#';
    prevA.textContent='¬´';
    prevA.addEventListener('click', e=>{
        e.preventDefault();
        if(currentPage>1){ currentPage--; renderTable(); }
    });
    prevLi.appendChild(prevA);
    pagination.appendChild(prevLi);

    // ƒ∞lk sayfa ve "..." kontrol√º
    if(startPage > 1){
        const li = document.createElement('li');
        li.className='page-item';
        const a=document.createElement('a');
        a.className='page-link';
        a.href='#';
        a.textContent=1;
        a.addEventListener('click', e=>{ e.preventDefault(); currentPage=1; renderTable(); });
        li.appendChild(a);
        pagination.appendChild(li);

        const dots = document.createElement('li');
        dots.className='page-item disabled';
        dots.innerHTML='<span class="page-link">...</span>';
        pagination.appendChild(dots);
    }

    // Sayfa numaralarƒ±
    for(let i=startPage;i<=endPage;i++){
        const li = document.createElement('li');
        li.className='page-item '+(i===currentPage?'active':'');
        const a=document.createElement('a');
        a.className='page-link';
        a.href='#';
        a.textContent=i;
        a.addEventListener('click', e=>{ e.preventDefault(); currentPage=i; renderTable(); });
        li.appendChild(a);
        pagination.appendChild(li);
    }

    // Son sayfa ve "..." kontrol√º
    if(endPage < totalPages){
        const dots = document.createElement('li');
        dots.className='page-item disabled';
        dots.innerHTML='<span class="page-link">...</span>';
        pagination.appendChild(dots);

        const li = document.createElement('li');
        li.className='page-item';
        const a=document.createElement('a');
        a.className='page-link';
        a.href='#';
        a.textContent=totalPages;
        a.addEventListener('click', e=>{ e.preventDefault(); currentPage=totalPages; renderTable(); });
        li.appendChild(a);
        pagination.appendChild(li);
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className='page-item ' + (currentPage===totalPages?'disabled':'');
    const nextA = document.createElement('a');
    nextA.className = 'page-link';
    nextA.href='#';
    nextA.textContent='¬ª';
    nextA.addEventListener('click', e=>{
        e.preventDefault();
        if(currentPage<totalPages){ currentPage++; renderTable(); }
    });
    nextLi.appendChild(nextA);
    pagination.appendChild(nextLi);
}


    if(search){
        search.oninput = ()=>{
            const term = (search.value||'').toLowerCase();
            filteredRows = rows.filter(r=>r.join(' ').toLowerCase().includes(term));
            currentPage=1;
            renderTable();
        };
    }

    renderTable();
}

// ---------------- IMAGE MODAL ----------------
function openImage(src){
    document.getElementById('modalImage').src=src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

// ---------------- EDIT / DELETE ----------------
function openEditModal(rowIndex){
    const row = photoRows[rowIndex];
    const modalHtml=`<div class="modal fade" id="rowEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Kayƒ±t D√ºzenle</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
        <form id="rowEditForm">
        ${row.map((v,i)=>`<label class="form-label">${i}</label><input class="form-control mb-2" data-col="${i}" value="${v}">`).join('')}
        </form>
        </div>
        <div class="modal-footer">
            <button id="saveRowBtn" class="btn btn-primary">Kaydet</button>
        </div>
        </div></div></div>`;
    document.getElementById('editModalContainer').innerHTML=modalHtml;
    const bs=new bootstrap.Modal(document.getElementById('rowEditModal'));
    bs.show();

    document.getElementById('saveRowBtn').onclick=async()=>{
        const inputs=document.querySelectorAll('#rowEditForm input');
        const newRow=Array.from(inputs).map(inp=>inp.value.trim());
        try{
            await fetch(BACKEND_BASE+'/api/duzenle',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({row:rowIndex+2, yeni:{
                    tarih:newRow[0], vardiya:newRow[1], hat:newRow[2],
                    aciklama:newRow[3], personel:newRow[4], foto_base64:'', kalitePersoneli:newRow[6]
                }})
            });
            bs.hide();
            loadDataFromBackend();
        }catch(e){ console.error(e); alert('D√ºzenleme hatasƒ±'); }
    };
}

async function deleteRow(rowIndex){
    if(!confirm('Satƒ±rƒ± silmek istediƒüinize emin misiniz?')) return;
    try{
        await fetch(BACKEND_BASE+'/api/sil',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({row:rowIndex+2})
        });
        loadDataFromBackend();
    }catch(e){ console.error(e); }
}

// ---------------- CHART ----------------
function renderChart(){
    try{
        const dateInput = document.getElementById('chartDate')?.value;
        const periodSelect = document.getElementById('chartPeriod')?.value || 'daily';
        const groupByCol = parseInt(document.getElementById('chartGroupBy')?.value || 3); // varsayƒ±lan a√ßƒ±klama
        let selectedDate = null;
        if(dateInput){
            const parts=dateInput.split('-');
            if(parts.length===3) selectedDate=new Date(+parts[0],+parts[1]-1,+parts[2]);
        }

        const counts = {};
        const labelsSet = new Set();

        photoRows.forEach(row=>{
            if(!row) return;
            const dateStr = row[0]||'';
            const groupValue = row[groupByCol] || 'Bilinmiyor';
            if(!dateStr) return;
            const d=parseDateFromDDMMYYYY(dateStr);
            if(!d) return;

            if(selectedDate){
                if(periodSelect==='daily' && dateStr!==formatDate(selectedDate)) return;
                if(periodSelect==='weekly' && weekKeyFromDate(selectedDate)!==weekKeyFromDate(d)) return;
                if(periodSelect==='monthly' && monthKeyFromDate(selectedDate)!==monthKeyFromDate(d)) return;
            }

            let key='';
            if(periodSelect==='daily') key=formatDate(d);
            else if(periodSelect==='weekly') key=weekKeyFromDate(d);
            else if(periodSelect==='monthly') key=monthKeyFromDate(d);

            labelsSet.add(key);
            const countKey=`${groupValue}|${key}`;
            counts[countKey]=(counts[countKey]||0)+1;
        });

        let labels=Array.from(labelsSet).sort();
        const groups={};
        for(const k in counts){
            const [groupValue,pKey]=k.split('|');
            if(!groups[groupValue]) groups[groupValue]={};
            groups[groupValue][pKey]=counts[k];
        }

        // Toplam deƒüere g√∂re b√ºy√ºkten k√º√ß√ºƒüe sƒ±rala
        const sortedGroups = Object.entries(groups)
            .map(([desc,dataObj])=>({desc, dataObj, total:Object.values(dataObj).reduce((a,b)=>a+b,0)}))
            .sort((a,b)=>b.total - a.total);

        const palette=["#ff595e","#ffca3a","#8ac926","#1982c4","#6a4c93","#ff6f91","#ff9671","#6bf178"];
        const datasets=[];
        sortedGroups.forEach((g,i)=>{
            const arr = labels.map(l=>g.dataObj[l]||0);
            datasets.push({
                label:g.desc,
                data:arr,
                backgroundColor:palette[i%palette.length],
                borderColor:'#fff',
                borderWidth:1,
                type:'bar'
            });
        });

        const ctx=document.getElementById('errorChart')?.getContext('2d');
        if(!ctx) return;
        if(errorChart) errorChart.destroy();
        errorChart=new Chart(ctx,{
            type:'bar',
            data:{labels,datasets},
            options:{
                responsive:true,
                maintainAspectRatio:false,
                plugins:{
                    legend:{position:'top'},
                    tooltip:{mode:'index',intersect:false}
                },
                scales:{
                    y:{beginAtZero:true},
                    x:{ticks:{autoSkip:false}}
                }
            }
        });

    }catch(e){ console.error(e); }
}



function parseDateFromDDMMYYYY(s){ if(!s) return null; const p=s.split('.'); if(p.length!==3) return null; const d=new Date(+p[2],+p[1]-1,+p[0]); return isNaN(d)?null:d; }
function weekKeyFromDate(d){ const onejan=new Date(d.getFullYear(),0,1); return 'W'+Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7); }
function monthKeyFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
function formatDate(d){ return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`; }

// ---------------- EVENT LISTENERS ----------------
document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('loginBtn')?.addEventListener('click',login);
    document.getElementById('logoutBtn')?.addEventListener('click',logout);

    document.getElementById('btnData')?.addEventListener('click',()=>{
        document.getElementById('dataTableWrapper').style.display='block'; 
        document.getElementById('photoTableWrapper').style.display='none'; 
        document.getElementById('chartWrapper').style.display='none'; 
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
        document.getElementById('btnData').classList.add('active'); 
    });
    document.getElementById('btnPhoto')?.addEventListener('click',()=>{
        document.getElementById('dataTableWrapper').style.display='none'; 
        document.getElementById('photoTableWrapper').style.display='block'; 
        document.getElementById('chartWrapper').style.display='none'; 
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
        document.getElementById('btnPhoto').classList.add('active'); 
    });
    document.getElementById('btnChart')?.addEventListener('click',()=>{
        document.getElementById('dataTableWrapper').style.display='none'; 
        document.getElementById('photoTableWrapper').style.display='none'; 
        document.getElementById('chartWrapper').style.display='block'; 
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
        document.getElementById('btnChart').classList.add('active'); 
        renderChart();
    });

    document.getElementById('chartDate')?.addEventListener('change',renderChart);
    document.getElementById('chartPeriod')?.addEventListener('change',renderChart);

    if(localStorage.getItem('loggedIn')==='true') showMain();
});
</script>
</body>
</html>
