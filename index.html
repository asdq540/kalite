<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kalite Kontrol Paneli</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
<style>
body { font-family: "Segoe UI", sans-serif; background: #f1f3f5; padding: 20px; }
.hidden { display: none; }
.table-container { overflow-x: auto; background: white; padding: 10px; border-radius: 12px; margin-bottom: 30px; }
.table thead { background: #093e72; color: white; }
.table tbody tr:hover { background: #e9f3ff; }
</style>
</head>
<body>

<!-- Login -->
<div id="loginPage" class="login-container" style="max-width:400px; margin:100px auto; padding:30px; background:white; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.1);">
  <h3 class="text-center mb-4">Kalite Kontrol Giriş</h3>
  <input type="text" id="username" class="form-control mb-3" placeholder="Kullanıcı adı">
  <input type="password" id="password" class="form-control mb-3" placeholder="Şifre">
  <button class="btn btn-primary w-100" onclick="login()">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- Ana Panel -->
<div id="mainPage" class="hidden container">
  <h1>Kalite Veri Listesi</h1>

  <h3>Veri Tablosu (J-Q)</h3>
  <div class="table-container">
    <table id="dataTable" class="table table-striped table-bordered">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <h3>Fotoğraf Tablosu (A-G)</h3>
  <div class="table-container">
    <table id="photoTable" class="table table-striped table-bordered">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="btn btn-outline-danger" onclick="logout()">Çıkış Yap</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";

// Giriş
function login() {
  const username = $('#username').val().trim();
  const password = $('#password').val().trim();
  const errorMsg = $('#errorMsg');

  fetch(BACKEND_URL + "/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      localStorage.setItem("loggedIn", "true");
      $('#loginPage').hide();
      $('#mainPage').show();
      loadTables();
    } else errorMsg.text("Kullanıcı adı veya şifre hatalı!");
  })
  .catch(()=>errorMsg.text("Sunucuya ulaşılamadı!"));
}

// Çıkış
function logout() {
  localStorage.removeItem("loggedIn");
  $('#mainPage').hide();
  $('#loginPage').show();
  $('#username').val('');
  $('#password').val('');
  $('#errorMsg').text('');
}

// Tablo yükleme
function loadTables() {
  fetch(sheetUrl)
    .then(res => res.text())
    .then(csvText => {
      const data = Papa.parse(csvText, { header:false }).data;

      // Veri Tablosu J-Q
      const dataHeaders = data[0].slice(9,17);
      const dataBody = data.slice(1).map(r=>r.slice(9,17));
      $('#dataTable thead').html('<tr>'+dataHeaders.map(h=>`<th>${h}</th>`).join('')+'</tr>');
      $('#dataTable tbody').html(dataBody.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join(''));

      // Fotoğraf Tablosu A-G
      const photoHeaders = data[0].slice(0,7);
      const photoBody = data.slice(1).map(r=>r.slice(0,7));
      $('#photoTable thead').html('<tr>'+photoHeaders.map(h=>`<th>${h}</th>`).join('')+'</tr>');
      $('#photoTable tbody').html(photoBody.map(r=>{
        return '<tr>'+r.map((c,i)=>{
          if(i===5 && c) return `<td><img src="${c}" style="max-height:80px; cursor:pointer;" onclick="window.open('${c}','_blank')"/></td>`;
          return `<td>${c}</td>`;
        }).join('')+'</tr>';
      }).join(''));

      // DataTables
      if($.fn.DataTable.isDataTable('#dataTable')) $('#dataTable').DataTable().destroy();
      if($.fn.DataTable.isDataTable('#photoTable')) $('#photoTable').DataTable().destroy();

      $('#dataTable').DataTable({ pageLength:20 });
      $('#photoTable').DataTable({ pageLength:20 });
    });
}

// Oturum kontrol
$(document).ready(function(){
  if(localStorage.getItem("loggedIn")==="true"){
    $('#loginPage').hide();
    $('#mainPage').show();
    loadTables();
  }
});
</script>

</body>
</html>
