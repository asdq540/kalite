<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kalite Kontrol Paneli</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>

<style>
body {
  background: #f1f3f5;
  font-family: "Segoe UI", sans-serif;
  padding: 20px;
}
.login-container {
  max-width: 420px;
  margin: 120px auto;
  padding: 35px;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
  border: 1px solid #dee2e6;
}
.login-container h3 { font-weight: 600; color: #093e72; }
#mainPage h1 { color: #093e72; font-weight: 700; margin-bottom: 25px; }
.table-container { overflow-x: auto; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); margin-bottom: 40px;}
.table thead { background: #093e72 !important; color: white; }
.table th, .table td { padding: 10px !important; font-size: 14px; text-align: center; }
.table tbody tr:hover { background: #e0f0ff !important; }
.dataTables_wrapper .dataTables_paginate .paginate_button { background-color: #0d6efd; color: white !important; border-radius: 6px; margin: 2px; }
.dataTables_wrapper .dataTables_paginate .paginate_button.current { background-color: #093e72 !important; }
.dataTables_wrapper .dataTables_filter input { border-radius: 8px; border: 1px solid #bfc4c9; padding: 5px 10px; }
.hidden { display: none; }
</style>
</head>
<body>

<!-- Login -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-4">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input type="text" id="username" class="form-control" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input type="password" id="password" class="form-control" placeholder="Şifrenizi girin">
  </div>
  <button class="btn btn-primary w-100" onclick="login()">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- Ana Panel -->
<div id="mainPage" class="hidden container">
  <h1>Kalite Veri Listesi</h1>

  <div class="table-container">
    <h4>Veri Tablosu (J-Q)</h4>
    <table id="dataTable" class="table table-striped table-hover display">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-container">
    <h4>Fotoğraf Tablosu (A-G)</h4>
    <table id="photoTable" class="table table-striped table-hover display">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="btn btn-outline-danger mb-4" onclick="logout()">Çıkış Yap</button>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";

// Login
function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorMsg = document.getElementById("errorMsg");

  fetch(BACKEND_URL + "/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  })
  .then(res => res.json())
  .then(data => {
    if(data.success){
      localStorage.setItem("loggedIn","true");
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("mainPage").classList.remove("hidden");
      loadTables();
    } else {
      errorMsg.textContent = "Kullanıcı adı veya şifre hatalı!";
    }
  })
  .catch(()=> { errorMsg.textContent = "Sunucuya ulaşılamadı!"; });
}

// Logout
function logout(){
  localStorage.removeItem("loggedIn");
  document.getElementById("mainPage").classList.add("hidden");
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("username").value="";
  document.getElementById("password").value="";
  document.getElementById("errorMsg").textContent="";
}

// Load tables
function loadTables(){
  fetch(sheetUrl)
  .then(res=>res.text())
  .then(csvText=>{
    const data = Papa.parse(csvText,{header:false}).data;

    // Veri Tablosu J-Q
    const dataHeaders = data[0].slice(9,17);
    const dataBody = data.slice(1).map(r=>r.slice(9,17));
    const dataTable = $('#dataTable');
    dataTable.find('thead').html('<tr>'+dataHeaders.map(h=>`<th>${h}</th>`).join('')+'</tr>');
    dataTable.find('tbody').html(dataBody.map(r=>'<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>').join(''));

    // Fotoğraf Tablosu A-G
    const photoHeaders = data[0].slice(0,7);
    const photoBody = data.slice(1).map(r=>r.slice(0,7));
    const photoTable = $('#photoTable');
    photoTable.find('thead').html('<tr>'+photoHeaders.map(h=>`<th>${h}</th>`).join('')+'</tr>');
    photoTable.find('tbody').html(photoBody.map(r=>{
      return '<tr>'+r.map((c,i)=>{
        if(i===5 && c) return `<td><img src="${c}" style="max-height:80px; cursor:pointer;" onclick="window.open('${c}','_blank')"/></td>`;
        return `<td>${c}</td>`;
      }).join('')+'</tr>';
    }).join(''));

    // Destroy previous DataTables
    if($.fn.DataTable.isDataTable('#dataTable')) dataTable.DataTable().destroy();
    if($.fn.DataTable.isDataTable('#photoTable')) photoTable.DataTable().destroy();

    // Initialize DataTables with Turkish
    const turkish = {
      "sEmptyTable":     "Tabloda veri yok",
      "sInfo":           "_TOTAL_ kayıttan _START_ - _END_ arası gösteriliyor",
      "sInfoEmpty":      "0 kayıttan 0 - 0 arası gösteriliyor",
      "sInfoFiltered":   "(_MAX_ kayıt içerisinden filtrelendi)",
      "sLengthMenu":     "Sayfada _MENU_ kayıt göster",
      "sLoadingRecords": "Yükleniyor...",
      "sProcessing":     "İşleniyor...",
      "sSearch":         "Ara:",
      "sZeroRecords":    "Eşleşen kayıt bulunamadı",
      "oPaginate": {
        "sFirst":    "İlk",
        "sLast":     "Son",
        "sNext":     "Sonraki",
        "sPrevious": "Önceki"
      }
    };

    dataTable.DataTable({ pageLength:20, order: [], language: turkish });
    photoTable.DataTable({ pageLength:20, order: [], language: turkish });
  });
}

// Check login on page load
window.onload = function(){
  if(localStorage.getItem("loggedIn")==="true"){
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("mainPage").classList.remove("hidden");
    loadTables();
  }
};
</script>
</body>
</html>
