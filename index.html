<script>
const BACKEND_BASE = 'https://vardiya-backend.onrender.com'; 
const PAGE_SIZE = 20;
let headerRow = [], dataRows = [], photoRows = [], errorChart = null;
let currentPhotoPage = 1;
let editRowIndex = null;
let editRowId = null; // ID saklamak için
const editModalEl = new bootstrap.Modal(document.getElementById('editModal'));

// --- LOGIN / LOGOUT / SHOW MAIN ---
async function login() {
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    const err = document.getElementById('errorMsg');
    err.textContent = '';
    if(!u||!p){ err.textContent='Kullanıcı adı ve şifre boş olamaz.'; return; }
    try{
        const res = await fetch(BACKEND_BASE + '/login',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username:u,password:p})
        });
        const data = await res.json();
        if(res.ok && data.success){
            localStorage.setItem('loggedIn','true');
            showMain();
        } else { err.textContent = data?.message || 'Giriş başarısız.'; }
    } catch(e){ err.textContent='Sunucuya ulaşılamadı.'; }
}
function logout(){ localStorage.removeItem('loggedIn'); location.reload(); }
function showMain(){ 
    document.getElementById('loginPage').style.display='none'; 
    document.getElementById('mainPage').style.display='block'; 
    loadDataFromBackend(); 
}

// --- LOAD DATA ---
async function loadDataFromBackend(){
    try{
        const res = await fetch(BACKEND_BASE + '/api/get');
        const json = await res.json();

        headerRow = json.dataHeader || [];
        dataRows = json.dataRows || [];
        photoRows = json.photoRows || [];
        
        document.getElementById('dataCount').textContent = dataRows.length;
        document.getElementById('photoCount').textContent = photoRows.length;

        createEditableTable('dataTable', headerRow, dataRows, 'searchInput1', 'pagination1', false);
        createEditableTable('photoTable', json.photoHeader, photoRows, 'searchInput2', 'pagination2', true);

        renderChart();
    } catch(e){ console.error('loadDataFromBackend error', e); }
}

// --- TABLE GENERATOR ---
function createEditableTable(tableId, headers, rows, searchId, paginationId, isPhoto=false){
    const table = document.getElementById(tableId);
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const search = document.getElementById(searchId);

    thead.innerHTML = '';
    const tr = document.createElement('tr');
    headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h||''; tr.appendChild(th); });
    if(isPhoto){ 
        const actionTh=document.createElement('th'); 
        actionTh.textContent='İşlemler'; 
        tr.appendChild(actionTh); 
    }
    thead.appendChild(tr);

    let filteredRows = [...rows];
    let currentPage = isPhoto ? currentPhotoPage : 1;

    function renderPage(){
        tbody.innerHTML='';
        const start = (currentPage-1)*PAGE_SIZE;
        const end = Math.min(start+PAGE_SIZE, filteredRows.length);
        for(let i=start;i<end;i++){
            const row = filteredRows[i];
            const tr=document.createElement('tr');
            // **A:H aralığı birebir**
            for(let colIndex=0; colIndex<8; colIndex++){
                const td=document.createElement('td');
                td.textContent = row[colIndex] || '';
                tr.appendChild(td);
            }
            if(isPhoto){
                const actionTd=document.createElement('td');

                const editBtn=document.createElement('button');
                editBtn.className='btn btn-sm btn-outline-primary me-2';
                editBtn.textContent='Düzenle';
                editBtn.addEventListener('click',()=>openEditModal(i));
                actionTd.appendChild(editBtn);

                const delBtn=document.createElement('button');
                delBtn.className='btn btn-sm btn-outline-danger';
                delBtn.textContent='Sil';
                delBtn.addEventListener('click',()=>deleteRow(i));
                actionTd.appendChild(delBtn);

                tr.appendChild(actionTd);
            }
            tbody.appendChild(tr);
        }

        // Pagination
        const paginationUl = document.getElementById(paginationId);
        paginationUl.innerHTML='';
        const totalPages = Math.ceil(filteredRows.length / PAGE_SIZE);
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow/2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
        if(endPage-startPage<maxPagesToShow-1){ startPage = Math.max(1, endPage-maxPagesToShow+1); }

        const createLi = (p,text,disabled=false,active=false)=>{
            const li = document.createElement('li'); li.className='page-item'+(disabled?' disabled':'')+(active?' active':'');
            const a = document.createElement('a'); a.className='page-link'; a.href='#'; a.textContent=text;
            a.addEventListener('click',e=>{ e.preventDefault(); if(!disabled){ currentPage=p; if(isPhoto) currentPhotoPage=p; renderPage(); } });
            li.appendChild(a); return li;
        };

        paginationUl.appendChild(createLi(currentPage-1,'«',currentPage===1));
        for(let p=startPage;p<=endPage;p++){ paginationUl.appendChild(createLi(p,p,p===currentPage,false)); }
        paginationUl.appendChild(createLi(currentPage+1,'»',currentPage===totalPages));
    }

    renderPage();

    // Filter
    if(search){
        search.oninput = ()=>{
            const term=(search.value||'').toLowerCase();
            filteredRows = rows.filter(row=>row.some(cell => (cell||'').toString().toLowerCase().includes(term)));
            currentPage = 1;
            renderPage();
        };
    }
}

// --- IMAGE MODAL ---
function openImage(src){
    document.getElementById('modalImage').src=src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

// --- EDIT MODAL ---
function openEditModal(rowIndex){
    editRowIndex = rowIndex;
    const row = photoRows[rowIndex];
    document.getElementById('editDescription').value = row[3] || '';
    document.getElementById('editPersonel').value = row[4] || '';
    document.getElementById('editVardiya').value = row[1] || '';
    document.getElementById('editHat').value = row[2] || '';
    editRowId = row[7] || null; // H sütunundaki ID
    editModalEl.show();
}

// --- SAVE EDIT ---
document.getElementById('saveEditBtn').addEventListener('click', async ()=>{
    if(editRowIndex === null || !editRowId) {
        alert('ID bulunamadı. Güncelleme yapılamıyor.');
        return;
    }

    const updatedDescription = document.getElementById('editDescription').value.trim();
    const updatedPersonel = document.getElementById('editPersonel').value.trim();
    const updatedVardiya = document.getElementById('editVardiya').value.trim();
    const updatedHat = document.getElementById('editHat').value.trim();

    // local update
    photoRows[editRowIndex][3] = updatedDescription;
    photoRows[editRowIndex][4] = updatedPersonel;
    photoRows[editRowIndex][1] = updatedVardiya;
    photoRows[editRowIndex][2] = updatedHat;

    try{
        await fetch(`${BACKEND_BASE}/api/duzenle`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                id: editRowId,
                aciklama: updatedDescription,
                personel: updatedPersonel,
                vardiya: updatedVardiya,
                hat: updatedHat
            })
        });
    } catch(err){
        console.error(err);
        alert('Google Sheets güncellenemedi.');
        return;
    }

    createEditableTable('photoTable', headerRow, photoRows, 'searchInput2', 'pagination2', true);
    editModalEl.hide();
    renderChart();
});

// --- DELETE ROW ---
async function deleteRow(rowIndex){
    if(!confirm('Bu satırı silmek istediğinize emin misiniz?')) return;

    const rowId = photoRows[rowIndex][7]; // H sütunundaki ID

    try{
        const res = await fetch(`${BACKEND_BASE}/api/sil`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({id: rowId})
        });
        const data = await res.json();
        if(!data.success){
            alert('Silme işlemi başarısız: '+(data.message||'Hata'));
            return;
        }
        photoRows.splice(rowIndex,1);
        createEditableTable('photoTable', headerRow, photoRows, 'searchInput2', 'pagination2', true);
    } catch(err){
        console.error(err);
        alert('Sunucuya ulaşılamadı.');
    }
}

// --- FOTOĞRAF GRAFİĞİ ---
function getPhotoColumnIndices() { return { aciklama:5, personel:4, hat:3, vardiya:2, tarih:1 }; }
function renderChart(){
    if(!photoRows || photoRows.length===0) return;
    const groupKey = document.getElementById("chartGroup")?.value || "aciklama";
    const period = document.getElementById("chartPeriod")?.value || "daily";
    const selectedDateStr = document.getElementById("chartDate")?.value || null;
    const indices = getPhotoColumnIndices();
    const col = indices[groupKey];
    if(col===undefined) return;
    const dateCol = indices['tarih'];
    const grouped = {};
    let targetDate = null;
    if(selectedDateStr){
        const parts = selectedDateStr.split('-');
        targetDate = new Date(+parts[0], +parts[1]-1, +parts[2]);
    }
    photoRows.forEach(r=>{
        let key = (r[col]||"Boş").toString().trim();
        const d = parseDateFromDDMMYYYY(r[dateCol]);
        if(!d) return;
        if(targetDate){
            if(period==="daily" && d.getTime()!==targetDate.getTime()) return;
            else if(period==="weekly" && weekKeyFromDate(d)!==weekKeyFromDate(targetDate)) return;
            else if(period==="monthly" && monthKeyFromDate(d)!==monthKeyFromDate(targetDate)) return;
        }
        grouped[key] = (grouped[key]||0)+1;
    });
    const labels = Object.keys(grouped).sort((a,b)=>grouped[b]-grouped[a]);
    const values = labels.map(k=>grouped[k]);
    if(errorChart) errorChart.destroy();
    const ctx = document.getElementById("errorChart").getContext("2d");
    let titleText = "";
    if(targetDate){
        if(period==="daily") titleText=formatDate(targetDate);
        else if(period==="weekly"){
            const d = targetDate;
            const startOfWeek = new Date(d); startOfWeek.setDate(d.getDate()-d.getDay()+1);
            const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate()+6);
            titleText = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
        } else if(period==="monthly") titleText = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}`;
    } else titleText = "Tarih seçilmedi";

    errorChart = new Chart(ctx,{
        type:"bar",
        data:{labels,datasets:[{label:"Adet",data:values,backgroundColor:"rgba(46,204,113,0.45)",borderColor:"rgba(46,204,113,1)",borderWidth:2,borderRadius:6}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true},title:{display:true,text:`${titleText} - Grup: ${groupKey.toUpperCase()}`}},scales:{x:{ticks:{color:"#222",font:{size:12}}},y:{beginAtZero:true}}}
    });
}

// --- HELPERS ---
function parseDateFromDDMMYYYY(s){ if(!s) return null; const p=s.split('.'); if(p.length!==3) return null; const d=new Date(+p[2],+p[1]-1,+p[0]); return isNaN(d)?null:d; }
function formatDate(d){ return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`; }
function weekKeyFromDate(d){ const onejan=new Date(d.getFullYear(),0,1); const week = Math.ceil((((d-onejan)/86400000) + onejan.getDay() + 1)/7); return `${d.getFullYear()}-W${String(week).padStart(2,'0')}`; }
function monthKeyFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

// --- DOMContentLoaded ---
document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('loginBtn')?.addEventListener('click',login);
    document.getElementById('logoutBtn')?.addEventListener('click',logout);

    document.getElementById('btnData')?.addEventListener('click',()=>{ 
        document.getElementById('dataTableWrapper').style.display='block'; 
        document.getElementById('photoTableWrapper').style.display='none'; 
        document.getElementById('chartWrapper').style.display='none'; 
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
        document.getElementById('btnData').classList.add('active'); 
    });

    document.getElementById('btnPhoto')?.addEventListener('click',()=>{ 
        document.getElementById('dataTableWrapper').style.display='none'; 
        document.getElementById('photoTableWrapper').style.display='block'; 
        document.getElementById('chartWrapper').style.display='none'; 
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
        document.getElementById('btnPhoto').classList.add('active'); 
    });

    document.getElementById('btnChart')?.addEventListener('click',()=>{ 
        document.getElementById('dataTableWrapper').style.display='none'; 
        document.getElementById('photoTableWrapper').style.display='none'; 
        document.getElementById('chartWrapper').style.display='block'; 
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
        document.getElementById('btnChart').classList.add('active'); 
        renderChart(); 
    });

document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('loginBtn')?.addEventListener('click',login);
    document.getElementById('logoutBtn')?.addEventListener('click',logout);
    // Tab ve sayfa geçişleri
    if(localStorage.getItem('loggedIn')==='true') showMain();
});
</script>
