<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalite Kontrol Paneli</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
:root{
  --primary:#2A9D8F;
  --bg:#f6f8fa;
  --card:#ffffff;
  --thead:#264653;
  --row1:#fefefe;
  --row2:#f1f3f5;
  --border:#d4d7dc;
  --shadow:0 4px 18px rgba(0,0,0,0.08);
}
body{
  background:var(--bg);
  font-family:"Segoe UI",sans-serif;
  padding:20px;
}
.login-container{
  max-width:420px;
  margin:90px auto;
  padding:30px;
  background:var(--card);
  border-radius:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
#mainPage{ display:none; }

.section-title{ 
  color:var(--thead); 
  font-weight:700; 
  font-size:26px;
}

/* TABLO TASARIMI */
.table-card{
  background:var(--card);
  padding:20px;
  border-radius:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  margin-bottom:30px;
}
.table{
  border-collapse:separate !important;
  border-spacing:0 10px !important;
}
.table thead th{
  background:var(--thead) !important;
  color:white !important;
  padding:14px !important;
  font-weight:600;
  text-align:center;
  border:none !important;
}
.table tbody tr{
  background:var(--row1);
  border-radius:12px;
}
.table tbody tr:nth-child(even){
  background:var(--row2);
}
.table tbody td{
  padding:14px !important;
  border-top:1px solid var(--border);
  border-bottom:1px solid var(--border);
  vertical-align:middle;
  text-align:center;
}
.table tbody tr td:first-child{
  border-left:1px solid var(--border);
  border-top-left-radius:12px;
  border-bottom-left-radius:12px;
}
.table tbody tr td:last-child{
  border-right:1px solid var(--border);
  border-top-right-radius:12px;
  border-bottom-right-radius:12px;
}

img.thumb{
  width:90px;
  height:74px;
  object-fit:cover;
  border-radius:10px;
  border:1px solid #cbd1d8;
  cursor:pointer;
}

.search-input{
  border-radius:10px;
  padding:10px;
  border:1px solid #bcc6d0;
}

/* Grafik alanı kısaldı */
#chartContainer{
  height: 260px !important;
  padding:15px;
}

/* Sekme butonları */
.tab-btn{
  padding:10px 16px;
  border-radius:30px;
  font-weight:600;
  border:1px solid var(--primary);
}
.tab-btn.active{
  background:var(--primary);
  color:white;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-3" style="color:var(--thead);">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input id="username" class="form-control">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input id="password" type="password" class="form-control">
  </div>
  <button onclick="login()" class="btn btn-primary w-100">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-2"></div>
</div>
<!-- BÖLÜM 3 — JavaScript: CSV yükleme, tablolar, sıralama, modal, grafik -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
/* --- GLOBALS --- */
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";
const PAGE_SIZE = 10;

let fullRows = [];    // ham CSV satırları (her satır bir array)
let dataRows = [];    // gösterim için kesilmiş veri (veri tablosu)
let photoRows = [];   // gösterim için kesilmiş veri (foto tablo)
let headerRow = [];
let errorChart = null;

/* --- AUTH --- */
function login(){
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  const err = document.getElementById('errorMsg'); err.textContent = "";
  if(!u || !p){ err.textContent = "Kullanıcı adı ve şifre boş olamaz."; return; }
  fetch(BACKEND_URL + "/login", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username: u, password: p})
  }).then(r=>r.json()).then(res=>{
    if(res && res.success){ localStorage.setItem("loggedIn","true"); showMain(); }
    else err.textContent = res?.message || "Giriş başarısız.";
  }).catch(()=> err.textContent = "Sunucuya ulaşılamadı.");
}

function logout(){ localStorage.removeItem("loggedIn"); location.reload(); }

function showMain(){
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('mainPage').style.display = 'block';
  loadCsvAndInit();
}

if(localStorage.getItem('loggedIn')==='true') showMain();

/* --- CSV LOAD --- */
function loadCsvAndInit(){
  fetch(sheetUrl).then(r=>r.text()).then(text=>{
    const parsed = Papa.parse(text, { header:false }).data;
    if(!parsed || parsed.length===0){ console.error("CSV boş veya okunamadı"); return; }
    headerRow = parsed[0];
    const body = parsed.slice(1);
    fullRows = body.map(r => r); // tüm satırı sakla (index'lerle çalışacağız)
    // oluşturduğumuz gösterim satırları (orijinal projenin önceki slice'ları)
    dataRows = body.map(r => r.slice(9,17));   // veri tablosu için (örnek)
    photoRows = body.map(r => r.slice(0,7));   // fotoğraf tablosu için (örnek)

    // tabloları oluştur
    createTable("dataTable", headerRow.slice(9,17), dataRows, "searchInput1", "pagination1", false, false);
    createTable("photoTable", headerRow.slice(0,7), photoRows, "searchInput2", "pagination2", true, true);

    // grafik ilk yüklemede render et (tümü)
    renderChart();
  }).catch(err=>{ console.error(err); });
}

/* --- GENERIC TABLE (data veya photo) --- */
function createTable(tableId, headers, rows, searchId, paginationId, isPhoto=false, dateSort=false){
  const table = document.getElementById(tableId);
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  const search = document.getElementById(searchId);
  const pagination = document.getElementById(paginationId);

  let filtered = [...rows];
  let page = 1;
  let sortAsc = false;
  let sortCol = null;

  function renderHead(){
    thead.innerHTML = "";
    const tr = document.createElement('tr');
    headers.forEach((h, idx) => {
      const th = document.createElement('th');
      th.textContent = h || '';
      // tarih sütunu için (foto table) tıklayınca sıralama
      if(dateSort && idx===0){
        th.style.cursor = 'pointer';
        th.title = 'Tarihe göre sırala';
        th.addEventListener('click', () => {
          sortCol = idx;
          sortAsc = !sortAsc;
          sortRows();
          page = 1;
          renderPage();
        });
      }
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function sortRows(){
    if(sortCol===null) return;
    filtered.sort((a,b)=>{
      // tarih formatı dd.mm.yyyy
      const da = a[sortCol] || '';
      const db = b[sortCol] || '';
      const pA = parseDateSafe(da);
      const pB = parseDateSafe(db);
      if(pA && pB){
        return sortAsc ? pA - pB : pB - pA;
      }
      // fallback string compare
      const sA = (a[sortCol] || '').toString().toLowerCase();
      const sB = (b[sortCol] || '').toString().toLowerCase();
      if(sA < sB) return sortAsc ? -1 : 1;
      if(sA > sB) return sortAsc ? 1 : -1;
      return 0;
    });
  }

  function renderPage(){
    tbody.innerHTML = '';
    const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    if(page > totalPages) page = totalPages;
    const start = (page-1)*PAGE_SIZE;
    const slice = filtered.slice(start, start + PAGE_SIZE);
    slice.forEach(row => {
      const tr = document.createElement('tr');
      row.forEach((cell, i) => {
        const td = document.createElement('td');
        if(isPhoto && i===5 && cell){
          const img = document.createElement('img');
          img.src = cell;
          img.className = 'thumb';
          img.loading = 'lazy';
          img.alt = 'foto';
          img.addEventListener('click', ()=> openImage(cell));
          td.appendChild(img);
        } else {
          td.textContent = cell ?? '';
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    renderPagination();
  }

  function renderPagination(){
    pagination.innerHTML = '';
    const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    const liPrev = document.createElement('li'); liPrev.className = 'page-item ' + (page===1?'disabled':'');
    const btnPrev = document.createElement('button'); btnPrev.className='page-link'; btnPrev.textContent='Geri';
    btnPrev.addEventListener('click', (e)=>{ e.preventDefault(); if(page>1){ page--; renderPage(); } });
    liPrev.appendChild(btnPrev); pagination.appendChild(liPrev);

    const liNext = document.createElement('li'); liNext.className = 'page-item ' + (page===totalPages?'disabled':'');
    const btnNext = document.createElement('button'); btnNext.className='page-link'; btnNext.textContent='İleri';
    btnNext.addEventListener('click', (e)=>{ e.preventDefault(); if(page<totalPages){ page++; renderPage(); } });
    liNext.appendChild(btnNext); pagination.appendChild(liNext);
  }

  search.oninput = function(){
    const term = (this.value || '').toLowerCase();
    filtered = rows.filter(r => r.join(' ').toLowerCase().includes(term));
    page = 1;
    // eğer tarih sıralaması varsayılan olarak ayarlanmış ise yeniden sırala
    sortRows();
    renderPage();
  }

  // Eğer tarih sıralı başlatılacaksa (foto tablo) default en yeni başa gelsin
  if(dateSort){
    sortCol = 0; sortAsc = false; // başlangıçta azalan (yeni -> eski)
    sortRows();
  }

  renderHead();
  renderPage();
}

/* güvenli tarih parse */
function parseDateSafe(s){
  if(!s || typeof s !== 'string') return null;
  const parts = s.split('.');
  if(parts.length !== 3) return null;
  const gg = parseInt(parts[0],10), aa = parseInt(parts[1],10), yyyy = parseInt(parts[2],10);
  if(isNaN(gg)||isNaN(aa)||isNaN(yyyy)) return null;
  return new Date(yyyy, aa-1, gg);
}

/* --- TABLAR ARASI GEÇİŞ --- */
const btnData = document.getElementById('btnData');
const btnPhoto = document.getElementById('btnPhoto');
const btnChart = document.getElementById('btnChart');

btnData.addEventListener('click', ()=> {
  document.getElementById('dataTableWrapper').style.display='block';
  document.getElementById('photoTableWrapper').style.display='none';
  document.getElementById('chartWrapper').style.display='none';
  setActive(btnData);
});
btnPhoto.addEventListener('click', ()=> {
  document.getElementById('dataTableWrapper').style.display='none';
  document.getElementById('photoTableWrapper').style.display='block';
  document.getElementById('chartWrapper').style.display='none';
  setActive(btnPhoto);
});
btnChart.addEventListener('click', ()=> {
  document.getElementById('dataTableWrapper').style.display='none';
  document.getElementById('photoTableWrapper').style.display='none';
  document.getElementById('chartWrapper').style.display='block';
  setActive(btnChart);
  renderChart();
});

function setActive(el){
  [btnData,btnPhoto,btnChart].forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}

/* --- MODAL (RESİM BÜYÜT) --- */
let modal = new bootstrap.Modal(document.getElementById('imageModal'));
function openImage(src){
  document.getElementById('modalImage').src = src;
  modal.show();
}

/* --- GRAFİK: T (date) = fullRows[row][19], U (desc) = [20], V (count) = [21] --- */
function renderChart(){
  // period ve seçili tarih
  const selectedDate = document.getElementById('chartDate').value; // yyyy-mm-dd veya ''
  const period = document.getElementById('chartPeriod') ? document.getElementById('chartPeriod').value : 'daily';

  // counts map: "desc|periodKey" => total
  const counts = {};

  // helper: parse fullRows row's date string safely
  function getRowDateStr(row){
    // row may be shorter; ensure index 19 exists
    const d = row[19];
    return (typeof d === 'string') ? d.trim() : '';
  }

  function getRowDesc(row){
    return (row[20]||'').toString().trim() || 'Açıklama Yok';
  }

  function getRowCount(row){
    return parseInt(row[21]) || 0;
  }

  // convert input date (yyyy-mm-dd) -> dd.mm.yyyy for daily comparison
  let formattedSelectedDate = null;
  if(selectedDate){
    const parts = selectedDate.split('-');
    if(parts.length===3){
      formattedSelectedDate = `${parts[2]}.${parts[1]}.${parts[0]}`; // dd.mm.yyyy
    }
  }

  // period key generator
  function periodKeyFor(dateStr){
    const dObj = parseDateSafe(dateStr);
    if(!dObj) return dateStr || 'unknown';
    if(period === 'daily') return dateStr;
    if(period === 'weekly'){
      const onejan = new Date(dObj.getFullYear(),0,1);
      const week = Math.ceil((((dObj - onejan)/86400000) + onejan.getDay() + 1) / 7);
      return `${dObj.getFullYear()}-W${week}`;
    }
    if(period === 'monthly'){
      return `${dObj.getFullYear()}-${String(dObj.getMonth()+1).padStart(2,'0')}`;
    }
    return dateStr;
  }

  // iterate fullRows (not sliced dataRows) so indices 19/20/21 are valid
  fullRows.forEach(row => {
    if(!row) return;
    const dateStr = getRowDateStr(row);
    if(!dateStr) return;
    // daily filter check
    if(period === 'daily' && formattedSelectedDate){
      if(dateStr !== formattedSelectedDate) return;
    }
    // if selectedDate not provided for weekly/monthly, show all period buckets
    const desc = getRowDesc(row);
    const cnt = getRowCount(row);
    const key = periodKeyFor(dateStr);
    const fullKey = `${desc}|${key}`;
    counts[fullKey] = (counts[fullKey] || 0) + cnt;
  });

  // group by desc and collect labels
  const descGroups = {}; // desc => { periodKey: value, ... }
  const labelsSet = new Set();
  for(const k in counts){
    const [desc, pKey] = k.split('|');
    labelsSet.add(pKey);
    if(!descGroups[desc]) descGroups[desc] = {};
    descGroups[desc][pKey] = counts[k];
  }

  const labels = [...labelsSet].sort();

  // build bar + line datasets: bar for counts, line for trend (same data)
  const barDatasets = [];
  const lineDatasets = [];
  const palette = ["#4B9CD3","#F4A261","#E76F51","#2A9D8F","#264653","#8AB17D","#F77F00","#3A86FF"];

  let idx = 0;
  for(const desc in descGroups){
    const arr = labels.map(l => descGroups[desc][l] || 0);
    const color = palette[idx % palette.length];

    barDatasets.push({
      label: desc + " (Bar)",
      data: arr,
      backgroundColor: color,
      borderColor: color,
      borderWidth: 1,
      type: 'bar'
    });

    lineDatasets.push({
      label: desc + " (Çizgi)",
      data: arr,
      borderColor: color,
      backgroundColor: color,
      tension: 0.25,
      fill: false,
      pointRadius: 3,
      borderWidth: 2,
      type: 'line',
      yAxisID: undefined
    });

    idx++;
  }

  const datasets = [...barDatasets, ...lineDatasets];

  // render Chart.js
  const ctx = document.getElementById('errorChart').getContext('2d');
  if(errorChart) errorChart.destroy();

  errorChart = new Chart(ctx, {
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true } },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { stacked: false },
        y: { beginAtZero: true }
      }
    }
  });

} // renderChart

// event listeners for chart controls
const chartDateEl = document.getElementById('chartDate');
if(chartDateEl) chartDateEl.addEventListener('change', ()=> renderChart());
const chartPeriodEl = document.getElementById('chartPeriod');
if(chartPeriodEl) chartPeriodEl.addEventListener('change', ()=> renderChart());

</script>

</body>
</html>
