<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalite Kontrol Paneli — Modern</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
/* --- SENİN MEVCUT CSS'İN --- */
:root{--primary:#9b59b6;--bg:#f6f8fa;--card:#ffffff;--thead:#8e44ad;--row1:#ffffff;--row2:#f3f4f6;--border:#d4d7dc;--shadow:0 4px 18px rgba(0,0,0,0.08)}
body{background:var(--bg);font-family:"Segoe UI",sans-serif;padding:20px}
/* Tüm CSS’niz buraya kopyalanabilir (önceki kod) */
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-container advanced-login">
  <div class="login-header text-center mb-4">
    <h2 class="login-title">Kalite Kontrol Paneli</h2>
    <p class="login-subtitle">Güvenli Giriş</p>
  </div>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input id="username" class="form-control login-input" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input id="password" type="password" class="form-control login-input" placeholder="Şifrenizi girin">
  </div>
  <div class="d-grid">
    <button id="loginBtn" class="btn login-btn">Giriş Yap</button>
  </div>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- MAIN -->
<div id="mainPage" class="container-fluid" style="display:none">
  <div class="d-flex gap-2 mb-3 align-items-center">
    <button id="btnData" class="tab-btn active">Veri Tablosu</button>
    <button id="btnPhoto" class="tab-btn">Fotoğraflar</button>
    <button id="btnChart" class="tab-btn">Grafik</button>
    <button id="logoutBtn" class="btn btn-outline-secondary ms-auto">Çıkış</button>
  </div>

  <!-- DATA -->
  <div id="dataTableWrapper">
    <div class="table-card">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="section-title mb-0">Veri Tablosu</h4>
        <div class="text-muted small">Satır: <span id="dataCount">0</span></div>
      </div>
      <input id="searchInput1" class="search-input mb-3" placeholder="Veri tablosunda ara...">
      <div class="table-responsive"><table id="dataTable" class="table"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- PHOTO -->
  <div id="photoTableWrapper" style="display:none">
    <div class="table-card">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="section-title mb-0">Fotoğraf Tablosu</h4>
        <div class="text-muted small">Satır: <span id="photoCount">0</span></div>
      </div>
      <input id="searchInput2" class="search-input mb-3" placeholder="Fotoğraf tablosunda ara...">
      <div class="table-responsive"><table id="photoTable" class="table"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>
</div>

<div id="editModalContainer"></div>
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content"><div class="modal-body p-0"><div style="background:#000;display:flex;align-items:center;justify-content:center;"><img id="modalImage" style="max-width:100%;max-height:80vh;"/></div></div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* FRONTEND SCRIPT - FULL INTEGRATION */
const BACKEND_BASE = ''; // same origin
const PAGE_SIZE = 10;

let headerRow = [], fullRows = [], dataRows = [], photoRows = [], errorChart = null;

// --- LOGIN ---
async function login(){
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    const err = document.getElementById('errorMsg'); err.textContent='';

    if(!u||!p){ err.textContent='Kullanıcı adı ve şifre boş olamaz.'; return; }

    // Demo login: her kullanıcı kabul
    localStorage.setItem('loggedIn','true');
    showMain();
}

function logout(){ localStorage.removeItem('loggedIn'); location.reload(); }
function showMain(){ 
    document.getElementById('loginPage').style.display='none'; 
    document.getElementById('mainPage').style.display='block'; 
    loadDataFromBackend(); 
}

// --- LOAD DATA ---
async function loadDataFromBackend(){
    try{
        const res = await fetch(BACKEND_BASE + '/api/get');
        const json = await res.json();

        headerRow = json.header || [];
        fullRows = json.rows || [];

        // Veri tablosu: J-O sütunları (9-14)
        dataRows = fullRows.map(r => r.slice(9,15));
        // Foto tablosu: A-G sütunları (0-6)
        photoRows = fullRows.map(r => r.slice(0,7));

        document.getElementById('dataCount').textContent = dataRows.length;
        document.getElementById('photoCount').textContent = photoRows.length;

        createEditableTable('dataTable', headerRow.slice(9,15), dataRows, 'searchInput1', 'pagination1');
        createEditableTable('photoTable', headerRow.slice(0,7), photoRows, 'searchInput2', 'pagination2', true);
        renderChart();

    }catch(e){
        console.error('loadDataFromBackend error',e);
    }
}

// --- TABLE CREATION ---
function createEditableTable(tableId, headers, rows, searchId, paginationId, isPhoto=false){
    const table = document.getElementById(tableId);
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const search = document.getElementById(searchId);

    thead.innerHTML='';
    const trHead = document.createElement('tr');
    headers.forEach(h=>{
        const th = document.createElement('th'); th.textContent=h||''; trHead.appendChild(th);
    });
    const actionTh = document.createElement('th'); actionTh.textContent='İşlemler'; trHead.appendChild(actionTh);
    thead.appendChild(trHead);

    tbody.innerHTML='';
    rows.forEach((row,rowIndex)=>{
        const tr = document.createElement('tr');
        row.forEach((cell,colIndex)=>{
            const td = document.createElement('td');
            if(isPhoto && colIndex===5 && cell){
                const img = document.createElement('img'); img.src=cell; img.className='thumb'; img.alt='foto';
                img.addEventListener('click',()=>openImage(cell));
                td.appendChild(img);
            } else td.textContent = cell||'';
            tr.appendChild(td);
        });

        // action buttons
        const actionTd = document.createElement('td');
        const editBtn = document.createElement('button'); editBtn.className='btn btn-sm btn-outline-primary me-2'; editBtn.textContent='Düzenle';
        editBtn.addEventListener('click',()=>openEditModal(tableId,rowIndex));
        actionTd.appendChild(editBtn);

        const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-outline-danger'; delBtn.textContent='Sil';
        delBtn.addEventListener('click',()=>deleteRow(tableId,rowIndex));
        actionTd.appendChild(delBtn);

        tr.appendChild(actionTd);
        tbody.appendChild(tr);
    });

    if(search){
        search.oninput = ()=>{
            const term = (search.value||'').toLowerCase();
            tbody.querySelectorAll('tr').forEach(r=>{
                r.style.display = r.innerText.toLowerCase().includes(term)?'':'none';
            });
        };
    }
}

// --- MODAL / INLINE EDIT / DELETE ---
function openImage(src){
    const img = document.getElementById('modalImage'); img.src=src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

async function deleteRow(tableId,rowIndex){
    if(!confirm('Satırı silmek istediğinize emin misiniz?')) return;
    try{
        const res = await fetch(BACKEND_BASE+'/api/sil',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row:rowIndex+2})});
        if(res.ok) loadDataFromBackend();
    }catch(e){console.error('deleteRow err',e);}
}

function openEditModal(tableId,rowIndex){
    const fullRow = fullRows[rowIndex]||[];
    const header = headerRow||[];
    let html=`<div class="modal fade" id="rowEditModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Kayıt Düzenle</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="rowEditForm">`;

    for(let i=0;i<fullRow.length;i++){
        const label = header[i]||('Kolon '+(i+1));
        html+=`<label class="form-label">${label}</label><input class="form-control mb-2" data-col="${i}" value="${fullRow[i]||''}">`;
    }
    html+=`</form></div><div class="modal-footer"><button id="saveRowBtn" class="btn btn-primary">Kaydet</button></div></div></div></div>`;

    const container=document.getElementById('editModalContainer'); container.innerHTML=html;
    const bs = new bootstrap.Modal(document.getElementById('rowEditModal')); bs.show();

    document.getElementById('saveRowBtn').onclick=async ()=>{
        const inputs = document.querySelectorAll('#rowEditForm input');
        const newRow = [];
        inputs.forEach(inp=>newRow[parseInt(inp.dataset.col)]=inp.value.trim());
        for(let k=0;k<fullRow.length;k++) if(newRow[k]===undefined) newRow[k]=fullRow[k]||'';

        try{
            await fetch(BACKEND_BASE+'/api/duzenle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({row:rowIndex+2,yeni:{
                tarih:newRow[0], vardiya:newRow[1], hat:newRow[2], aciklama:newRow[3], personel:newRow[4],
                foto_base64:null, foto_url:newRow[5], kalitePersoneli:newRow[6]
            }})});
            bs.hide();
            loadDataFromBackend();
        }catch(e){console.error('updateRow err',e);}
    };
}

// --- INIT ---
document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('loginBtn').addEventListener('click',login);
    document.getElementById('logoutBtn').addEventListener('click',logout);

    document.getElementById('btnData')?.addEventListener('click',()=>{
        document.getElementById('dataTableWrapper').style.display='block';
        document.getElementById('photoTableWrapper').style.display='none';
        document.getElementById('chartWrapper').style.display='none';
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('btnData').classList.add('active');
    });
    document.getElementById('btnPhoto')?.addEventListener('click',()=>{
        document.getElementById('dataTableWrapper').style.display='none';
        document.getElementById('photoTableWrapper').style.display='block';
        document.getElementById('chartWrapper').style.display='none';
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('btnPhoto').classList.add('active');
    });
    document.getElementById('btnChart')?.addEventListener('click',()=>{
        document.getElementById('dataTableWrapper').style.display='none';
        document.getElementById('photoTableWrapper').style.display='none';
        document.getElementById('chartWrapper').style.display='block';
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('btnChart').classList.add('active');
    });

    if(localStorage.getItem('loggedIn')==='true') showMain();
});

</script>
</body>
</html>
