<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalite Kontrol Paneli — Modern</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
/* --- SENİN MEVCUT CSS'İN --- */
:root{--primary:#9b59b6;--bg:#f6f8fa;--card:#ffffff;--thead:#8e44ad;--row1:#ffffff;--row2:#f3f4f6;--border:#d4d7dc;--shadow:0 4px 18px rgba(0,0,0,0.08)}
body{background:var(--bg);font-family:"Segoe UI",sans-serif;padding:20px}
/* Tüm CSS’niz buraya kopyalanabilir (önceki kod) */
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-container advanced-login">
  <div class="login-header text-center mb-4">
    <h2 class="login-title">Kalite Kontrol Paneli</h2>
    <p class="login-subtitle">Güvenli Giriş</p>
  </div>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input id="username" class="form-control login-input" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input id="password" type="password" class="form-control login-input" placeholder="Şifrenizi girin">
  </div>
  <div class="d-grid">
    <button id="loginBtn" class="btn login-btn">Giriş Yap</button>
  </div>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- MAIN -->
<div id="mainPage" class="container-fluid" style="display:none">
  <div class="d-flex gap-2 mb-3 align-items-center">
    <button id="btnData" class="tab-btn active">Veri Tablosu</button>
    <button id="btnPhoto" class="tab-btn">Fotoğraflar</button>
    <button id="btnChart" class="tab-btn">Grafik</button>
    <button id="logoutBtn" class="btn btn-outline-secondary ms-auto">Çıkış</button>
  </div>

  <!-- DATA -->
  <div id="dataTableWrapper">
    <div class="table-card">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="section-title mb-0">Veri Tablosu</h4>
        <div class="text-muted small">Satır: <span id="dataCount">0</span></div>
      </div>
      <input id="searchInput1" class="search-input mb-3" placeholder="Veri tablosunda ara...">
      <div class="table-responsive"><table id="dataTable" class="table"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- PHOTO -->
  <div id="photoTableWrapper" style="display:none">
    <div class="table-card">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="section-title mb-0">Fotoğraf Tablosu</h4>
        <div class="text-muted small">Satır: <span id="photoCount">0</span></div>
      </div>
      <input id="searchInput2" class="search-input mb-3" placeholder="Fotoğraf tablosunda ara...">
      <div class="table-responsive"><table id="photoTable" class="table"><thead></thead><tbody></tbody></table></div>
    </div>
  </div>
</div>

<div id="editModalContainer"></div>
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content"><div class="modal-body p-0"><div style="background:#000;display:flex;align-items:center;justify-content:center;"><img id="modalImage" style="max-width:100%;max-height:80vh;"/></div></div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const BACKEND_BASE = ''; 
let fullRows = [];

// LOGIN
document.getElementById('loginBtn').addEventListener('click', ()=>{
  localStorage.setItem('loggedIn','true');
  showMain();
});
document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('loggedIn'); location.reload(); });

if(localStorage.getItem('loggedIn')==='true') showMain();

function showMain(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('mainPage').style.display='block';
  loadData();
}

// TAB SWITCH
document.getElementById('btnData').addEventListener('click', ()=>showSection('data'));
document.getElementById('btnPhoto').addEventListener('click', ()=>showSection('photo'));
function showSection(section){
  document.getElementById('dataTableWrapper').style.display = section==='data'?'block':'none';
  document.getElementById('photoTableWrapper').style.display = section==='photo'?'block':'none';
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  if(section==='data') document.getElementById('btnData').classList.add('active');
  if(section==='photo') document.getElementById('btnPhoto').classList.add('active');
}

// LOAD DATA
async function loadData(){
  try{
    const res = await fetch(BACKEND_BASE+'/api/get');
    const records = await res.json();
    if(!Array.isArray(records)) return;

    // FIRST ROW HEADERS
    const headerRow = Object.keys(records[0]||{});
    
    // FOTOĞRAF TABLO: A-G -> 0-6
    const photoHeader = headerRow.slice(0,7);
    const photoRows = records.map(r=>photoHeader.map(h=>r[h]||''));

    // VERİ TABLO: J-O -> 9-14 (ilk satır başlık)
    const dataHeader = headerRow.slice(9,15);
    const dataRows = records.map(r=>dataHeader.map(h=>r[h]||''));
    fullRows = dataRows;

    createTable('photoTable', photoHeader, photoRows,true);
    createTable('dataTable', dataHeader, dataRows);

    document.getElementById('dataCount').textContent = dataRows.length;
    document.getElementById('photoCount').textContent = photoRows.length;

  }catch(e){ console.error(e); }
}

// CREATE TABLE + INLINE EDIT + MODAL EDIT + DELETE
function createTable(tableId, headers, rows, isPhoto=false){
  const table = document.getElementById(tableId);
  const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody');
  thead.innerHTML=''; tbody.innerHTML='';

  // HEADER
  const trh=document.createElement('tr');
  headers.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  const actionTh=document.createElement('th'); actionTh.textContent='İşlemler'; trh.appendChild(actionTh);
  thead.appendChild(trh);

  // ROWS
  rows.forEach((r,rowIndex)=>{
    const tr=document.createElement('tr');
    r.forEach((c,colIndex)=>{
      const td=document.createElement('td');
      td.textContent=c||'';
      td.addEventListener('dblclick',()=>activateInline(td,rowIndex,colIndex,tableId,isPhoto));
      tr.appendChild(td);
    });
    // ACTION BUTTONS
    const actionTd=document.createElement('td');
    const editBtn=document.createElement('button'); editBtn.textContent='Düzenle'; editBtn.className='btn btn-sm btn-outline-primary me-2';
    editBtn.addEventListener('click',()=>openEditModal(rowIndex));
    const delBtn=document.createElement('button'); delBtn.textContent='Sil'; delBtn.className='btn btn-sm btn-outline-danger';
    delBtn.addEventListener('click',()=>deleteRow(rowIndex));
    actionTd.appendChild(editBtn); actionTd.appendChild(delBtn); tr.appendChild(actionTd);

    tbody.appendChild(tr);
  });
}

// INLINE EDIT
function activateInline(td,rowIndex,colIndex,tableId,isPhoto){
  const old=td.textContent;
  td.innerHTML=`<input class="form-control form-control-sm" value="${old}">`;
  const input=td.querySelector('input');
  input.focus();
  input.addEventListener('keydown',async e=>{
    if(e.key==='Enter'){
      const val=input.value.trim();
      td.textContent=val;
      try{
        await fetch(BACKEND_BASE+'/api/duzenle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
          row: rowIndex+2, // Google Sheet 1-index + header
          yeni: { 
            [colIndex]: val 
          }
        })});
        await loadData();
      }catch(err){ console.error(err); td.textContent=old; }
    }
    if(e.key==='Escape') td.textContent=old;
  });
  input.addEventListener('blur',()=>{ td.textContent=old; });
}

// MODAL EDIT
function openEditModal(rowIndex){
  const fullRow = fullRows[rowIndex]||[];
  let html=`<div class="modal fade" id="rowEditModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Satır Düzenle</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="rowEditForm">`;
  fullRow.forEach((val,i)=>{
    html+=`<label class="form-label">Kolon ${i+1}</label><input class="form-control mb-2" data-col="${i}" value="${val}">`;
  });
  html+=`</form></div><div class="modal-footer"><button id="saveRowBtn" class="btn btn-primary">Kaydet</button></div></div></div></div>`;
  const container=document.getElementById('editModalContainer'); container.innerHTML=html;
  const bs=new bootstrap.Modal(document.getElementById('rowEditModal')); bs.show();
  document.getElementById('saveRowBtn').onclick=async()=>{
    const inputs=document.querySelectorAll('#rowEditForm input');
    const newRow={};
    inputs.forEach(inp=>newRow[inp.dataset.col]=inp.value);
    try{
      await fetch(BACKEND_BASE+'/api/duzenle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        row: rowIndex+2,
        yeni: newRow
      })});
      bs.hide(); await loadData();
    }catch(e){ console.error(e); alert('Güncelleme hatası'); }
  };
}

// DELETE ROW
async function deleteRow(rowIndex){
  if(!confirm('Satırı silmek istediğinize emin misiniz?')) return;
  try{
    await fetch(BACKEND_BASE+'/api/sil',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ row: rowIndex+2 })});
    await loadData();
  }catch(e){ console.error(e); }
}

// IMAGE MODAL
function openImage(src){ document.getElementById('modalImage').src=src; new bootstrap.Modal(document.getElementById('imageModal')).show(); }
</script>
</body>
</html>
