<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kalite Kontrol Paneli</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
:root {
  --primary: #0d6efd;
  --primary-dark: #0b5ed7;
  --background: #f1f3f5;
  --card-bg: #ffffff;
  --table-header: #093e72;
}

body {
  background: var(--background);
  padding: 20px;
  font-family: "Segoe UI", sans-serif;
}

.login-container {
  max-width: 420px;
  margin: 120px auto;
  padding: 35px;
  background: var(--card-bg);
  border-radius: 14px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
  border: 1px solid #dee2e6;
}
.login-container h3 { font-weight: 600; color: #093e72; }

#mainPage h1 { color: #093e72; font-weight: 700; margin-bottom: 25px; }

#searchInput {
  margin-bottom: 20px;
  border-radius: 10px;
  padding: 10px 15px;
  border: 1px solid #bfc4c9;
}

.table-container {
  overflow-x: auto;
  background: white;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
}

.table thead { background: var(--table-header) !important; color: white; }
.table th, .table td { padding: 12px !important; font-size: 15px; border: 1px solid #dee2e6 !important; }
.table tbody tr:hover { background: #e9f3ff !important; }

.btn-outline-danger { margin-top: 20px; font-weight: 600; border-radius: 10px; }
.hidden { display: none; }

/* Sekme butonları */
.tab-btn { margin-right: 10px; }
.tab-btn.active { background: var(--primary); color:white; }

.photo-name { display:inline-block; padding:3px 6px; border-radius:5px; }
</style>
</head>
<body>

<!-- Login -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-4">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input type="text" id="username" class="form-control" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input type="password" id="password" class="form-control" placeholder="Şifrenizi girin">
  </div>
  <button class="btn btn-primary w-100" onclick="login()">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- Ana Panel -->
<div id="mainPage" class="hidden container">
  <h1>Kalite Kontrol Paneli</h1>
  <div class="mb-3">
    <button class="btn tab-btn active" onclick="showTab('data')">Veri Tablosu</button>
    <button class="btn tab-btn" onclick="showTab('photos')">Fotoğraf Tablosu</button>
  </div>

  <!-- Veri Tablosu -->
  <div id="dataTab">
    <input type="text" id="searchInputData" class="form-control" placeholder="Tabloda ara...">
    <div class="table-container">
      <table class="table table-striped table-hover" id="dataTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="mt-2">
      <button class="btn btn-secondary" onclick="prevPage('data')">Geri</button>
      <button class="btn btn-secondary" onclick="nextPage('data')">İleri</button>
      <span id="dataPageInfo"></span>
    </div>
  </div>

  <!-- Fotoğraf Tablosu -->
  <div id="photosTab" class="hidden">
    <input type="text" id="searchInputPhotos" class="form-control" placeholder="Tabloda ara...">
    <div class="table-container">
      <table class="table table-striped table-hover" id="photoTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="mt-2">
      <button class="btn btn-secondary" onclick="prevPage('photos')">Geri</button>
      <button class="btn btn-secondary" onclick="nextPage('photos')">İleri</button>
      <span id="photoPageInfo"></span>
    </div>
  </div>

  <button class="btn btn-outline-danger mt-3" onclick="logout()">Çıkış Yap</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";

// Sayfa ve veriler için
let dataRows = [], photoRows = [];
let dataPage = 1, photoPage = 1;
const pageSize = 20;

// İsimlere özel soft renkler
const nameColors = {};
const softColors = ['#e0f7fa','#fce4ec','#fff3e0','#f3e5f5','#e8f5e9','#fffde7','#ede7f6','#fbe9e7'];

function getNameColor(name){
  if(!nameColors[name]){
    const index = Object.keys(nameColors).length % softColors.length;
    nameColors[name] = softColors[index];
  }
  return nameColors[name];
}

// Sekmeler
function showTab(tab){
  document.getElementById('dataTab').classList.add('hidden');
  document.getElementById('photosTab').classList.add('hidden');
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  if(tab==='data'){
    document.getElementById('dataTab').classList.remove('hidden');
    document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
  } else {
    document.getElementById('photosTab').classList.remove('hidden');
    document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
  }
}

// Login
function login(){
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorMsg = document.getElementById("errorMsg");

  fetch(BACKEND_URL + "/login", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username,password})
  }).then(r=>r.json())
    .then(d=>{
      if(d.success){
        localStorage.setItem("loggedIn","true");
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("mainPage").classList.remove("hidden");
        loadCSV();
      } else {
        errorMsg.textContent = "Kullanıcı adı veya şifre hatalı!";
      }
    }).catch(()=>{errorMsg.textContent="Sunucuya ulaşılamadı!";});
}

// Logout
function logout(){
  localStorage.removeItem("loggedIn");
  document.getElementById("mainPage").classList.add("hidden");
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("username").value="";
  document.getElementById("password").value="";
  document.getElementById("errorMsg").textContent="";
}

// CSV Yükle
function loadCSV(){
  fetch(sheetUrl)
    .then(r=>r.text())
    .then(csvText=>{
      const data = Papa.parse(csvText,{header:false}).data;

      dataRows = data.slice(1).map(r=>r.slice(9,17)); // J-Q
      photoRows = data.slice(1).map(r=>r.slice(0,7)); // A-G

      renderPage('data');
      renderPage('photos');

      setupSearch();
    });
}

// Sayfa render
function renderPage(tab){
  const table = tab==='data'? document.getElementById('dataTable') : document.getElementById('photoTable');
  const rows = tab==='data'? dataRows : photoRows;
  const page = tab==='data'? dataPage : photoPage;

  const start = (page-1)*pageSize;
  const end = start+pageSize;
  const pageData = rows.slice(start,end);

  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');
  thead.innerHTML=''; tbody.innerHTML='';

  const headers = pageData.length>0? Object.keys(pageData[0]).map((_,i)=>i) : [];
  // Başlık
  const trHead = document.createElement('tr');
  const headerRow = tab==='data'? dataRows[0] : photoRows[0];
  if(headerRow){
    headerRow.forEach(text=>{
      const th = document.createElement('th'); th.textContent=text; trHead.appendChild(th);
    });
  }
  thead.appendChild(trHead);

  // İçerik
  pageData.forEach(r=>{
    const tr = document.createElement('tr');
    r.forEach((cell,idx)=>{
      const td = document.createElement('td');
      if(tab==='photos' && idx===0){ // isim sütunu
        const span = document.createElement('span');
        span.textContent=cell;
        span.className='photo-name';
        span.style.background = getNameColor(cell);
        td.appendChild(span);
      } else td.textContent=cell;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  if(tab==='data'){
    document.getElementById('dataPageInfo').textContent=`Sayfa ${dataPage}/${Math.ceil(rows.length/pageSize)}`;
  } else {
    document.getElementById('photoPageInfo').textContent=`Sayfa ${photoPage}/${Math.ceil(rows.length/pageSize)}`;
  }
}

// Sayfalama
function nextPage(tab){ 
  if(tab==='data'){
    if(dataPage*pageSize<dataRows.length) dataPage++;
  } else {
    if(photoPage*pageSize<photoRows.length) photoPage++;
  }
  renderPage(tab);
}
function prevPage(tab){ 
  if(tab==='data'){ if(dataPage>1) dataPage--; } 
  else { if(photoPage>1) photoPage--; }
  renderPage(tab);
}

// Arama
function setupSearch(){
  document.getElementById('searchInputData').addEventListener('keyup',e=>{
    const filter = e.target.value.toLowerCase();
    dataPage=1;
    renderPage('data');
    const tbody = document.getElementById('dataTable').querySelector('tbody');
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.style.display = tr.textContent.toLowerCase().includes(filter)? '' : 'none';
    });
  });
  document.getElementById('searchInputPhotos').addEventListener('keyup',e=>{
    const filter = e.target.value.toLowerCase();
    photoPage=1;
    renderPage('photos');
    const tbody = document.getElementById('photoTable').querySelector('tbody');
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.style.display = tr.textContent.toLowerCase().includes(filter)? '' : 'none';
    });
  });
}

// Sayfa yüklendiğinde oturum kontrolü
window.onload = function(){
  if(localStorage.getItem("loggedIn")==="true"){
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("mainPage").classList.remove("hidden");
    loadCSV();
  }
};
</script>

</body>
</html>
