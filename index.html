<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kalite Kontrol Paneli</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
:root {
  --primary: #0d6efd;
  --primary-dark: #0b5ed7;
  --background: #f1f3f5;
  --card-bg: #ffffff;
  --table-header: #093e72;
}

body {
  background: var(--background);
  padding: 20px;
  font-family: "Segoe UI", sans-serif;
}

/* Login Kutusu */
.login-container {
  max-width: 420px;
  margin: 120px auto;
  padding: 35px;
  background: var(--card-bg);
  border-radius: 14px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
  border: 1px solid #dee2e6;
}
.login-container h3 { font-weight: 600; color: #093e72; }

/* Tab Menü */
.tab-menu {
  margin-bottom: 20px;
}
.tab-menu button {
  margin-right: 10px;
}

/* Tablolar */
.table-container {
  overflow-x: auto;
  background: white;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
}

.table {
  border-collapse: collapse !important;
  width: 100%;
}
.table th, .table td {
  border: 1px solid #dee2e6 !important;
  padding: 8px;
}
.table thead th {
  background: var(--table-header);
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 2;
}

/* Gizleme */
.hidden { display: none; }

/* Responsive küçük ekranlarda butonlar düzeni */
@media (max-width: 576px) {
  .tab-menu button {
    display: inline-block;
    margin-bottom: 8px;
    width: 48%;
  }
}
</style>
</head>
<body>

<!-- Login -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-4">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input type="text" id="username" class="form-control" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input type="password" id="password" class="form-control" placeholder="Şifrenizi girin">
  </div>
  <button class="btn btn-primary w-100" onclick="login()">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- Ana Panel -->
<div id="mainPage" class="hidden container">

  <h1 class="mb-4">Kalite Kontrol Paneli</h1>

  <!-- TAB MENÜ -->
  <div class="tab-menu mb-3">
    <button id="tabVeriBtn" class="btn btn-primary" onclick="showTab('veriTablosu')">Veri Tablosu</button>
    <button id="tabFotoBtn" class="btn btn-outline-secondary" onclick="showTab('fotoTablosu')">Fotoğraf Tablosu</button>
  </div>

  <!-- ARAMA -->
  <input type="text" id="searchInput" class="form-control mb-3" placeholder="Arama yapın...">

  <!-- VERİ TABLOSU (J–Q) -->
  <div id="veriTablosu" class="table-container">
    <table class="table table-striped table-hover" id="dataTable1">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- FOTOĞRAF TABLOSU (A–G + Fotoğraf) -->
  <div id="fotoTablosu" class="table-container hidden">
    <table class="table table-striped table-hover" id="dataTable2">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="btn btn-outline-danger mt-3" onclick="logout()">Çıkış Yap</button>

</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";

/* ---------------------- LOGIN ---------------------- */
function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorMsg = document.getElementById("errorMsg");

  fetch(BACKEND_URL + "/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      localStorage.setItem("loggedIn", "true");
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("mainPage").classList.remove("hidden");
      loadTables();
      showTab('veriTablosu'); // varsayılan sekme
    } else {
      errorMsg.textContent = "Kullanıcı adı veya şifre hatalı!";
    }
  })
  .catch(() => errorMsg.textContent = "Sunucuya ulaşılamadı!");
}

function logout() {
  localStorage.removeItem("loggedIn");
  location.reload();
}

/* ---------------------- TAB MENÜ ---------------------- */
function showTab(tabName) {
  document.getElementById("veriTablosu").classList.add("hidden");
  document.getElementById("fotoTablosu").classList.add("hidden");
  document.getElementById(tabName).classList.remove("hidden");

  // sekme buton renkleri
  const tabVeriBtn = document.getElementById('tabVeriBtn');
  const tabFotoBtn = document.getElementById('tabFotoBtn');
  if (tabName === 'veriTablosu') {
    tabVeriBtn.classList.replace('btn-outline-secondary','btn-primary');
    tabVeriBtn.classList.add('btn-primary');
    tabVeriBtn.classList.remove('btn-outline-secondary');
    tabFotoBtn.classList.remove('btn-primary');
    tabFotoBtn.classList.add('btn-outline-secondary');
  } else {
    tabFotoBtn.classList.replace('btn-outline-secondary','btn-primary');
    tabFotoBtn.classList.add('btn-primary');
    tabFotoBtn.classList.remove('btn-outline-secondary');
    tabVeriBtn.classList.remove('btn-primary');
    tabVeriBtn.classList.add('btn-outline-secondary');
  }

  // mevcut arama değerini aktif tabloya uygula
  filterVisibleTable();
}

/* ---------------------- TABLOLARI YÜKLE ---------------------- */
function loadTables() {
  fetch(sheetUrl)
    .then(res => res.text())
    .then(csv => {
      const data = Papa.parse(csv, { header: false }).data;
      loadVeriTablosu(data);
      loadFotoTablosu(data);
      // arama kutusuna event listener sadece bir kez ekle
      const searchInput = document.getElementById('searchInput');
      searchInput.removeEventListener('input', filterVisibleTable); // guard
      searchInput.addEventListener('input', filterVisibleTable);
    })
    .catch(err => {
      console.error('Sheet yüklenirken hata:', err);
    });
}

/* ----- VERİ TABLOSU (J–Q) ----- */
function loadVeriTablosu(data) {
  const startCol = 9;  
  const endCol = 16;

  const thead = document.querySelector("#dataTable1 thead");
  const tbody = document.querySelector("#dataTable1 tbody");
  thead.innerHTML = ""; tbody.innerHTML = "";

  const headerRow = document.createElement("tr");
  data[0].slice(startCol, endCol + 1).forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  data.slice(1).forEach(row => {
    const tr = document.createElement("tr");
    row.slice(startCol, endCol + 1).forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell !== undefined ? cell : '';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/* ----- FOTOĞRAF TABLOSU (A–G + Fotoğraf) ----- */
function loadFotoTablosu(data) {
  const startCol = 0;
  const endCol = 6;

  const thead = document.querySelector("#dataTable2 thead");
  const tbody = document.querySelector("#dataTable2 tbody");
  thead.innerHTML = ""; tbody.innerHTML = "";

  const headerRow = document.createElement("tr");
  data[0].slice(startCol, endCol + 1).forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    headerRow.appendChild(th);
  });

  const photoTh = document.createElement("th");
  photoTh.textContent = "Fotoğraf";
  headerRow.appendChild(photoTh);
  thead.appendChild(headerRow);

  data.slice(1).forEach(row => {
    const tr = document.createElement("tr");
    row.slice(startCol, endCol + 1).forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell !== undefined ? cell : '';
      tr.appendChild(td);
    });

    const photoTd = document.createElement("td");
    const photoUrl = row[5]; // F sütunu (index 5)

    if (photoUrl && photoUrl.trim() !== "") {
      // güvenlik için URL encode edilmesine dikkat et
      const safeUrl = photoUrl.replace(/'/g, "%27");
      photoTd.innerHTML = `
        <button class="btn btn-sm btn-primary" onclick="window.open('${safeUrl}', '_blank')">
          Fotoğrafı Aç
        </button>`;
    } else {
      photoTd.innerHTML = `<span class="text-muted">Yok</span>`;
    }

    tr.appendChild(photoTd);
    tbody.appendChild(tr);
  });
}

/* ----- ARAMA: Görünür tabloyu filtrele ----- */
function filterVisibleTable() {
  const filter = (document.getElementById('searchInput').value || '').toLowerCase().trim();

  // hangi tablo görünürse onun tbody'sini seç
  const veriVisible = !document.getElementById('veriTablosu').classList.contains('hidden');
  const tbody = veriVisible
    ? document.querySelector('#dataTable1 tbody')
    : document.querySelector('#dataTable2 tbody');

  if (!tbody) return;

  tbody.querySelectorAll('tr').forEach(tr => {
    const text = (tr.textContent || '').toLowerCase();
    tr.style.display = text.includes(filter) ? '' : 'none';
  });
}

/* ---------------------- OTURUM KONTROL ---------------------- */
window.onload = () => {
  if (localStorage.getItem("loggedIn") === "true") {
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("mainPage").classList.remove("hidden");
    loadTables();
    showTab('veriTablosu');
  }
};
</script>

</body>
</html>
