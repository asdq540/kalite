<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalite Kontrol Paneli</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
:root{
  --primary:#2A9D8F;
  --bg:#f6f8fa;
  --card:#ffffff;
  --thead:#264653;
  --row1:#ffffff;
  --row2:#f3f4f6;
  --border:#d4d7dc;
  --shadow:0 4px 18px rgba(0,0,0,0.08);
}
body{
  background:var(--bg);
  font-family:"Segoe UI",sans-serif;
  padding:20px;
}
.login-container{
  max-width:420px;
  margin:90px auto;
  padding:30px;
  background:var(--card);
  border-radius:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
#mainPage{ display:none; }

.section-title{ 
  color:var(--thead); 
  font-weight:700; 
  font-size:26px;
}

/* TABLO TASARIMI */
.table-card{
  background:var(--card);
  padding:20px;
  border-radius:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  margin-bottom:30px;
}
.table{
  border-collapse:separate !important;
  border-spacing:0 10px !important;
}
.table thead th{
  background:var(--thead) !important;
  color:white !important;
  padding:14px !important;
  font-weight:600;
  text-align:center;
  border:none !important;
}
.table tbody tr{
  background:var(--row1);
  border-radius:12px;
}
.table tbody tr:nth-child(even){
  background:var(--row2);
}
.table tbody td{
  padding:14px !important;
  border-top:1px solid var(--border);
  border-bottom:1px solid var(--border);
  vertical-align:middle;
  text-align:center;
}
.table tbody tr td:first-child{
  border-left:1px solid var(--border);
  border-top-left-radius:12px;
  border-bottom-left-radius:12px;
}
.table tbody tr td:last-child{
  border-right:1px solid var(--border);
  border-top-right-radius:12px;
  border-bottom-right-radius:12px;
}

img.thumb{
  width:90px;
  height:74px;
  object-fit:cover;
  border-radius:10px;
  border:1px solid #cbd1d8;
  cursor:pointer;
}

/* Arama */
.search-input{
  border-radius:10px;
  padding:10px;
  border:1px solid #bcc6d0;
}

/* Grafik yüksekliği — 2 KAT ARTTIRILDI */
#chartContainer{
  height:520px !important;  /* eski 260 idi → 520 yapıldı */
  padding:15px;
}

/* Sekme butonları */
.tab-btn{
  padding:10px 16px;
  border-radius:30px;
  font-weight:600;
  border:1px solid var(--primary);
  background:white;
}
.tab-btn.active{
  background:var(--primary);
  color:white;
}
</style>
</head>
<body>

<!-- LOGIN SAYFASI -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-3" style="color:var(--thead);">Kalite Kontrol Giriş</h3>

  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input id="username" class="form-control">
  </div>

  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input id="password" type="password" class="form-control">
  </div>

  <button onclick="login()" class="btn btn-primary w-100">Giriş Yap</button>

  <div id="errorMsg" class="text-danger text-center mt-2"></div>
</div>

<!-- ANA SAYFA -->
<div id="mainPage">

  <div class="d-flex gap-2 mb-4">
    <button id="btnData"  class="tab-btn active">Veri Tablosu</button>
    <button id="btnPhoto" class="tab-btn">Fotoğraflar</button>
    <button id="btnChart" class="tab-btn">Grafik</button>
    <button class="btn btn-danger ms-auto" onclick="logout()">Çıkış</button>
  </div>

  <!-- VERİ TABLOSU -->
  <div id="dataTableWrapper">
    <div class="table-card">
      <h4 class="section-title mb-3">Veriler</h4>
      <input id="searchInput1" class="search-input mb-3" placeholder="Ara...">

      <table id="dataTable" class="table">
        <thead></thead>
        <tbody></tbody>
      </table>

      <ul id="pagination1" class="pagination justify-content-center"></ul>
    </div>
  </div>

  <!-- FOTO TABLOSU -->
  <div id="photoTableWrapper" style="display:none;">
    <div class="table-card">
      <h4 class="section-title mb-3">Fotoğraflar</h4>
      <input id="searchInput2" class="search-input mb-3" placeholder="Ara...">

      <table id="photoTable" class="table">
        <thead></thead>
        <tbody></tbody>
      </table>

      <ul id="pagination2" class="pagination justify-content-center"></ul>
    </div>
  </div>

  <!-- GRAFİK -->
  <div id="chartWrapper" style="display:none;">
    <div class="table-card">
      <h4 class="section-title mb-3">Tekrar Sayısı Grafiği (T–U–V)</h4>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Tarih Seç (Opsiyonel)</label>
          <input type="date" id="chartDate" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">Periyot</label>
          <select id="chartPeriod" class="form-select">
            <option value="daily">Günlük</option>
            <option value="weekly">Haftalık</option>
            <option value="monthly">Aylık</option>
          </select>
        </div>
      </div>

      <div id="chartContainer">
        <canvas id="errorChart"></canvas>
      </div>
    </div>
  </div>

</div>

<!-- FOTO MODAL -->
<div class="modal fade" id="imageModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <img id="modalImage" style="width:100%;border-radius:8px;">
    </div>
  </div>
</div>


<!-- JS KÜTÜPHANELERİ -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ============================
   GLOBALS
============================ */
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";
const PAGE_SIZE = 10;

let fullRows = [];    
let dataRows = [];    
let photoRows = [];   
let headerRow = [];

let errorChart = null;


/* ============================
   LOGIN
============================ */
function login(){
  const u = username.value.trim();
  const p = password.value.trim();
  errorMsg.textContent = "";

  if(!u || !p){
    errorMsg.textContent = "Kullanıcı adı ve şifre boş olamaz.";
    return;
  }

  fetch(BACKEND_URL + "/login", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:u, password:p})
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      localStorage.setItem("loggedIn","true");
      showMain();
    } else {
      errorMsg.textContent = res.message || "Giriş başarısız.";
    }
  }).catch(()=>{
    errorMsg.textContent = "Sunucuya ulaşılamadı.";
  });
}

function logout(){
  localStorage.removeItem("loggedIn");
  location.reload();
}

if(localStorage.getItem("loggedIn")==="true") showMain();


/* ============================
   ANA SAYFAYI AÇ + CSV YÜKLE
============================ */
function showMain(){
  loginPage.style.display = "none";
  mainPage.style.display = "block";
  loadCsv();
}

function loadCsv(){
  fetch(sheetUrl).then(r=>r.text()).then(text=>{
    const parsed = Papa.parse(text,{header:false}).data;

    headerRow = parsed[0];
    fullRows = parsed.slice(1);

    dataRows  = fullRows.map(r => r.slice(9,17));
    photoRows = fullRows.map(r => r.slice(0,7));

    createTable("dataTable",  headerRow.slice(9,17), dataRows,  "searchInput1", "pagination1", false, false);
    createTable("photoTable", headerRow.slice(0,7), photoRows, "searchInput2", "pagination2", true,  true);

    renderChart();
  });
}

/* ============================
   TABLOLAR
============================ */
function createTable(tableId, headers, rows, searchId, paginationId, isPhoto, dateSort){
  const table = document.getElementById(tableId);
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  const search = document.getElementById(searchId);
  const pagination = document.getElementById(paginationId);

  let filtered = [...rows];
  let page = 1;
  let sortCol = null;
  let sortAsc = false;

  function renderHead(){
    thead.innerHTML = "";
    let tr = document.createElement("tr");
    headers.forEach((h,i)=>{
      let th = document.createElement("th");
      th.textContent = h;

      if(dateSort && i===0){
        th.style.cursor="pointer";
        th.onclick = ()=>{
          sortCol=i;
          sortAsc=!sortAsc;
          sortRows();
          renderPage();
        };
      }

      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function sortRows(){
    filtered.sort((a,b)=>{
      if(sortCol===null) return 0;

      let A = a[sortCol]||"";
      let B = b[sortCol]||"";

      let dA = parseDateSafe(A);
      let dB = parseDateSafe(B);

      if(dA && dB){
        return sortAsc ? dA - dB : dB - dA;
      }

      A = A.toString().toLowerCase();
      B = B.toString().toLowerCase();
      if(A<B) return sortAsc?-1:1;
      if(A>B) return sortAsc?1:-1;
      return 0;
    });
  }

  if(dateSort){
    sortCol = 0;
    sortAsc = false; // en yeni başta
    sortRows();
  }

  function renderPage(){
    tbody.innerHTML="";
    let start = (page-1)*PAGE_SIZE;
    let slice = filtered.slice(start, start+PAGE_SIZE);

    slice.forEach(r=>{
      let tr=document.createElement("tr");

      r.forEach((cell,idx)=>{
        let td=document.createElement("td");

        if(isPhoto && idx===5 && cell){
          let img=document.createElement("img");
          img.src=cell;
          img.className="thumb";
          img.onclick=()=>openImage(cell);
          td.appendChild(img);
        }
        else td.textContent=cell||"";

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    renderPagination();
  }

  function renderPagination(){
    pagination.innerHTML="";

    let totalPages = Math.max(1, Math.ceil(filtered.length/PAGE_SIZE));

    let prev=document.createElement("li");
    prev.className="page-item " + (page===1?"disabled":"");
    let prevBtn=document.createElement("button");
    prevBtn.className="page-link";
    prevBtn.textContent="Geri";
    prevBtn.onclick=()=>{ if(page>1){page--;renderPage();} };
    prev.appendChild(prevBtn);
    pagination.appendChild(prev);

    let next=document.createElement("li");
    next.className="page-item " + (page===totalPages?"disabled":"");
    let nextBtn=document.createElement("button");
    nextBtn.className="page-link";
    nextBtn.textContent="İleri";
    nextBtn.onclick=()=>{ if(page<totalPages){page++;renderPage();} };
    next.appendChild(nextBtn);
    pagination.appendChild(next);
  }

  search.oninput=function(){
    let t=this.value.toLowerCase();
    filtered = rows.filter(r => r.join(" ").toLowerCase().includes(t));
    page=1;
    if(sortCol!==null) sortRows();
    renderPage();
  };

  renderHead();
  renderPage();
}

/* ============================
   TARİH PARSE
============================ */
function parseDateSafe(s){
  if(!s) return null;
  let p=s.split(".");
  if(p.length!==3) return null;
  let d=new Date(p[2], p[1]-1, p[0]);
  return isNaN(d)?null:d;
}

/* ============================
   MODAL
============================ */
function openImage(src){
  modalImage.src=src;
  new bootstrap.Modal(document.getElementById("imageModal")).show();
}

/* ============================
   SEKMELER
============================ */
btnData.onclick = ()=>{
  dataTableWrapper.style.display="block";
  photoTableWrapper.style.display="none";
  chartWrapper.style.display="none";
  activate(btnData);
};
btnPhoto.onclick = ()=>{
  dataTableWrapper.style.display="none";
  photoTableWrapper.style.display="block";
  chartWrapper.style.display="none";
  activate(btnPhoto);
};
btnChart.onclick = ()=>{
  dataTableWrapper.style.display="none";
  photoTableWrapper.style.display="none";
  chartWrapper.style.display="block";
  activate(btnChart);
  renderChart();
};

function activate(btn){
  btnData.classList.remove("active");
  btnPhoto.classList.remove("active");
  btnChart.classList.remove("active");
  btn.classList.add("active");
}

/* ============================
   GRAFİK (ÇİZGİ KALDIRILDI — SADECE BAR)
============================ */
function renderChart(){

  let selectedDate = chartDate.value;
  let period = chartPeriod.value;

  let formattedDate = null;
  if(selectedDate){
    let p = selectedDate.split("-");
    formattedDate = `${p[2]}.${p[1]}.${p[0]}`; // dd.mm.yyyy
  }

  let counts = {};
  let labelsSet = new Set();

  fullRows.forEach(row=>{
    let dateStr = row[19] || "";
    let desc    = row[20] || "Açıklama Yok";
    let count   = parseInt(row[21]) || 0;

    if(!dateStr) return;

    // günlük filtre
    if(period==="daily" && formattedDate && dateStr!==formattedDate) return;

    let d = parseDateSafe(dateStr);
    if(!d) return;

    let key="";
    if(period==="daily")  key=dateStr;
    if(period==="weekly"){
      let onejan=new Date(d.getFullYear(),0,1);
      let week = Math.ceil((((d - onejan)/86400000)+onejan.getDay()+1)/7);
      key=`${d.getFullYear()}-W${week}`;
    }
    if(period==="monthly"){
      key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    }

    labelsSet.add(key);
    let link = desc+"|"+key;
    counts[link] = (counts[link]||0) + count;
  });

  let labels = [...labelsSet].sort();

  // dataset üret
  let groups = {};
  for(let k in counts){
    let [desc, periodKey] = k.split("|");
    if(!groups[desc]) groups[desc]={};
    groups[desc][periodKey]=counts[k];
  }

  const palette=["#4B9CD3","#F4A261","#E76F51","#2A9D8F","#264653","#8AB17D","#F77F00","#3A86FF"];

  let datasets=[];
  let i=0;
  for(let desc in groups){
    let arr = labels.map(l=> groups[desc][l]||0 );
    let c = palette[i % palette.length];

    datasets.push({
      label: desc,
      data: arr,
      backgroundColor:c,
      borderWidth:0,
      type:"bar"
    });

    i++;
  }

  let ctx=document.getElementById("errorChart").getContext("2d");
  if(errorChart) errorChart.destroy();

  errorChart=new Chart(ctx,{
    data:{ labels, datasets },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{position:"top"},
        tooltip:{mode:"index", intersect:false}
      },
      scales:{
        y:{beginAtZero:true}
      }
    }
  });
}

chartDate.onchange=renderChart;
chartPeriod.onchange=renderChart;

</script>
</body>
</html>
