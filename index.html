<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kalite Kontrol Paneli</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

<style>
:root {
  --primary: #0d6efd;
  --background: #f1f3f5;
  --card-bg: #ffffff;
  --table-header: #093e72;
}

body {
  background: var(--background);
  padding: 20px;
  font-family: "Segoe UI", sans-serif;
}

.login-container {
  max-width: 420px;
  margin: 120px auto;
  padding: 35px;
  background: var(--card-bg);
  border-radius: 14px;
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
  border: 1px solid #dee2e6;
}
.login-container h3 { font-weight: 600; color: #093e72; }

.tab-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
.tab-buttons button {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  font-size: 16px;
}
.tab-active { background: var(--primary); color: white; }
.tab-passive { background: #dce3eb; color: #093e72; }

.table-container {
  overflow-x: auto;
  background: white;
  padding: 10px;
  border-radius: 12px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.08);
}
.table thead { background: var(--table-header) !important; color: white; }
.table th, .table td { border: 1px solid #ccc !important; }

.hidden { display: none; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-4">Kalite Kontrol Giriş</h3>
  <div class="mb-3">
    <label class="form-label">Kullanıcı Adı</label>
    <input type="text" id="username" class="form-control" placeholder="Kullanıcı adınızı girin">
  </div>
  <div class="mb-3">
    <label class="form-label">Şifre</label>
    <input type="password" id="password" class="form-control" placeholder="Şifrenizi girin">
  </div>
  <button class="btn btn-primary w-100" onclick="login()">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center mt-3"></div>
</div>

<!-- ANA PANEL -->
<div id="mainPage" class="hidden container">
  <div class="tab-buttons">
    <button id="tabDataBtn" class="tab-active" onclick="showTab('data')">Veri Tablosu</button>
    <button id="tabPhotoBtn" class="tab-passive" onclick="showTab('photos')">Fotoğraflar</button>
  </div>

  <!-- VERİ TABLOSU -->
  <div id="dataTab">
    <h2>Veri Tablosu (J → Q)</h2>
    <input id="searchData" type="text" class="form-control mb-3" placeholder="Ara...">
    <div class="table-container">
      <table class="table table-hover" id="dataTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <nav class="mt-3">
      <ul id="paginationData" class="pagination justify-content-center"></ul>
    </nav>
  </div>

  <!-- FOTO TABLOSU -->
  <div id="photoTab" class="hidden">
    <h2>Fotoğraflar (A → G)</h2>
    <input id="searchPhoto" type="text" class="form-control mb-3" placeholder="Ara...">
    <div class="table-container">
      <table class="table table-hover" id="photoTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <nav class="mt-3">
      <ul id="paginationPhoto" class="pagination justify-content-center"></ul>
    </nav>
  </div>

  <button class="btn btn-outline-danger mt-3" onclick="logout()">Çıkış Yap</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const BACKEND_URL = "https://kaliteform.onrender.com";
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBWFSVSD6NvBNqC8me1le_unCCLOKIOIS2DfZFXUTji0MHC7SaWNIy4a0Laob9xOiAJyPnp7LuZ1R-/pub?output=csv";
const rowsPerPage = 20;

// LOGIN
function login(){
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorMsg = document.getElementById("errorMsg");

  fetch(BACKEND_URL + "/login", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username,password})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      localStorage.setItem("loggedIn","true");
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("mainPage").classList.remove("hidden");
      loadTable('data');
      loadTable('photos');
    } else { errorMsg.textContent="Kullanıcı adı veya şifre hatalı!"; }
  }).catch(()=>errorMsg.textContent="Sunucuya ulaşılamadı!");
}

function logout(){
  localStorage.removeItem("loggedIn");
  document.getElementById("mainPage").classList.add("hidden");
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("username").value="";
  document.getElementById("password").value="";
  document.getElementById("errorMsg").textContent="";
}

// SEKME GEÇİŞİ
function showTab(tab){
  if(tab==='data'){
    document.getElementById("dataTab").classList.remove("hidden");
    document.getElementById("photoTab").classList.add("hidden");
    document.getElementById("tabDataBtn").classList.add("tab-active");
    document.getElementById("tabDataBtn").classList.remove("tab-passive");
    document.getElementById("tabPhotoBtn").classList.add("tab-passive");
    document.getElementById("tabPhotoBtn").classList.remove("tab-active");
  } else {
    document.getElementById("photoTab").classList.remove("hidden");
    document.getElementById("dataTab").classList.add("hidden");
    document.getElementById("tabPhotoBtn").classList.add("tab-active");
    document.getElementById("tabPhotoBtn").classList.remove("tab-passive");
    document.getElementById("tabDataBtn").classList.add("tab-passive");
    document.getElementById("tabDataBtn").classList.remove("tab-active");
  }
}

// TABLO YÜKLEME
function loadTable(tab){
  fetch(sheetUrl)
    .then(res=>res.text())
    .then(csvText=>{
      const data = Papa.parse(csvText,{header:false}).data;
      if(tab==='data') renderPaginatedTable(data,9,16,'dataTable','paginationData','searchData');
      if(tab==='photos') renderPaginatedTable(data,0,6,'photoTable','paginationPhoto','searchPhoto',true);
    });
}

function renderPaginatedTable(data,startCol,endCol,tableId,paginationId,searchId,isPhoto=false){
  const table = document.getElementById(tableId);
  const tbody = table.querySelector('tbody');
  const thead = table.querySelector('thead');
  thead.innerHTML = "";
  tbody.innerHTML = "";

  // HEADER
  const headerRow = document.createElement('tr');
  data[0].slice(startCol,endCol+1).forEach(h=>{
    const th = document.createElement('th'); th.textContent=h; headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  let filtered = data.slice(1);

  function renderPage(page){
    tbody.innerHTML="";
    const start = (page-1)*rowsPerPage;
    const end = start+rowsPerPage;
    filtered.slice(start,end).forEach(row=>{
      const tr=document.createElement('tr');
      row.slice(startCol,endCol+1).forEach((cell,idx)=>{
        const td=document.createElement('td');
        if(isPhoto && idx===5 && cell) td.innerHTML=`<button class="btn btn-sm btn-primary" onclick="window.open('${cell}','_blank')">Foto</button>`;
        else td.textContent=cell;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function setupPagination(){
    const pagination = document.getElementById(paginationId);
    pagination.innerHTML="";
    const totalPages = Math.ceil(filtered.length/rowsPerPage);
    for(let i=1;i<=totalPages;i++){
      const li=document.createElement('li'); li.className='page-item';
      const a=document.createElement('a'); a.className='page-link'; a.href="#"; a.textContent=i;
      a.addEventListener('click',e=>{e.preventDefault(); renderPage(i); });
      li.appendChild(a); pagination.appendChild(li);
    }
    renderPage(1);
  }

  // ARAMA
  const searchInput = document.getElementById(searchId);
  searchInput.addEventListener('keyup',()=>{
    const filter=searchInput.value.toLowerCase();
    filtered = data.slice(1).filter(r=>r.slice(startCol,endCol+1).join(" ").toLowerCase().includes(filter));
    setupPagination();
  });

  setupPagination();
}

// SAYFA YÜKLENDİĞİNDE OTURUM KONTROLÜ
window.onload = function(){
  if(localStorage.getItem("loggedIn")==="true"){
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("mainPage").classList.remove("hidden");
    loadTable('data');
    loadTable('photos');
  }
};
</script>
</body>
</html>
