/* --- GRAFİK --- */
let errorChart=null;

function renderChart(){
  const selectedDate=document.getElementById('chartDate').value;
  const period=document.getElementById('chartPeriod').value;

  // counts: { "Açıklama|Periyot": toplam }
  const counts={};

  // Tarihi uygun formatta döndüren fonksiyon
  let formatDate=(d)=>d; // default günlük
  if(period==='weekly'){
    formatDate=(d)=>{
      const [day,month,year]=d.split('.');
      const dt=new Date(year, month-1, day);
      const onejan=new Date(dt.getFullYear(),0,1);
      const week=Math.ceil((((dt-onejan)/86400000)+onejan.getDay()+1)/7);
      return dt.getFullYear()+'-W'+week;
    };
  } else if(period==='monthly'){
    formatDate=(d)=>{
      const parts=d.split('.');
      return parts[2]+'-'+parts[1]; // yyyy-mm
    };
  }

  dataRows.forEach(r=>{
    const dateStr=r[19]; // T sütunu → tarih
    const desc=r[20]?.trim()||"Bilinmeyen"; // U sütunu → açıklama
    const count=parseInt(r[21])||0; // V sütunu → tekrar sayısı

    if(selectedDate && period==='daily' && dateStr!==selectedDate.split('-').reverse().join('.')) return;

    const key=formatDate(dateStr);
    counts[desc+'|'+key]=(counts[desc+'|'+key]||0)+count;
  });

  const descKeys={}, labelSet=new Set();
  for(const k in counts){
    const [desc,date]=k.split('|');
    if(!descKeys[desc]) descKeys[desc]=[];
    descKeys[desc].push({date,count:counts[k]});
    labelSet.add(date);
  }

  const labels=[...labelSet].sort();
  const datasets=[], colors=['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff','#ff9f40'];
  let i=0;
  for(const desc in descKeys){
    const data=labels.map(l=>{
      const entry=descKeys[desc].find(e=>e.date===l);
      return entry?entry.count:0;
    });
    datasets.push({label:desc, data, backgroundColor:colors[i%colors.length]});
    i++;
  }

  const ctx=document.getElementById('errorChart').getContext('2d');
  if(errorChart) errorChart.destroy();
  errorChart=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets},
    options:{
      responsive:true,
      plugins:{legend:{position:'top'}},
      maintainAspectRatio:false
    }
  });
}
