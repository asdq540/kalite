<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kalite Kontrol Paneli</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
:root{--primary:#9b59b6;--bg:#f6f8fa;--card:#fff;--thead:#8e44ad;--border:#d4d7dc;--shadow:0 4px 18px rgba(0,0,0,0.08);}
body{background:var(--bg);font-family:"Segoe UI",sans-serif;padding:20px;}
.login-container{max-width:420px;margin:90px auto;padding:30px;background:var(--card);border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--border);}
#mainPage{display:none;}
.table-card{background:var(--card);padding:18px;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:20px;}
.table thead th{background: linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;padding:12px;text-align:center;position:sticky;top:0;}
.table tbody td{text-align:center;padding:10px;border-top:1px solid var(--border);}
.btn-edit{background:#2a9d8f;color:#fff;border:none;padding:4px 8px;border-radius:6px;margin:0 2px;}
.btn-delete{background:#e76f51;color:#fff;border:none;padding:4px 8px;border-radius:6px;margin:0 2px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
  <h3 class="text-center mb-3">Kalite Kontrol Paneli</h3>
  <input id="username" class="form-control mb-2" placeholder="Kullanıcı Adı">
  <input id="password" type="password" class="form-control mb-2" placeholder="Şifre">
  <button id="loginBtn" class="btn btn-primary w-100 mb-2">Giriş Yap</button>
  <div id="errorMsg" class="text-danger text-center"></div>
</div>

<!-- MAIN -->
<div id="mainPage" class="container-fluid">
  <button id="logoutBtn" class="btn btn-secondary mb-2">Çıkış</button>
  <div class="table-card">
    <h4>Veri Tablosu</h4>
    <input id="searchInput" class="form-control mb-2" placeholder="Ara...">
    <div class="table-responsive">
      <table id="dataTable" class="table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- MODAL DÜZENLEME -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5>Düzenle</h5>
      <input id="editTarih" class="form-control mb-1" placeholder="Tarih">
      <input id="editVardiya" class="form-control mb-1" placeholder="Vardiya">
      <input id="editHat" class="form-control mb-1" placeholder="Hat">
      <input id="editAciklama" class="form-control mb-1" placeholder="Açıklama">
      <input id="editPersonel" class="form-control mb-1" placeholder="Personel">
      <input id="editKalite" class="form-control mb-1" placeholder="Kalite Personeli">
      <input id="editFotoBase64" type="file" class="form-control mb-2" accept="image/*">
      <button id="saveEditBtn" class="btn btn-success w-100">Kaydet</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const BACKEND_URL = "https://vardiya-backend.onrender.com"; // backend adresin
let rows = [], currentEditRow = null;

document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value.trim();
  if(!u||!p){document.getElementById('errorMsg').textContent="Boş bırakılamaz";return;}
  document.getElementById('loginPage').style.display='none';
  document.getElementById('mainPage').style.display='block';
  await loadData();
});

document.getElementById('logoutBtn').addEventListener('click',()=>location.reload());

async function loadCsvAndInit(){
  try {
    const res = await fetch(`${BACKEND_URL}/api/get`);
    if(!res.ok) throw new Error('Backend fetch failed');
    const jsonData = await res.json();

    if(!Array.isArray(jsonData)) throw new Error('Geçersiz veri formatı');

    // Google Sheets’ten gelen veriler array of objects şeklinde
    headerRow = Object.keys(jsonData[0] || {});
    fullRows = jsonData.map(r => headerRow.map(h => r[h]));

    // Veri ve foto tablosu için slice
    dataRows = fullRows.map(r => r.slice(3, 7));    // Açıklama, Personel, Foto, KalitePersoneli
    photoRows = fullRows.map(r => r.slice(0, 3));   // Tarih, Vardiya, Hat

    document.getElementById('dataCount').textContent = dataRows.length;
    document.getElementById('photoCount').textContent = photoRows.length;

    createTable('dataTable', headerRow.slice(3, 7), dataRows, 'searchInput1', 'pagination1');
    createTable('photoTable', headerRow.slice(0, 3), photoRows, 'searchInput2', 'pagination2', true, true);
    renderChart();

  } catch(err) {
    console.warn('Veri çekilemedi, offline demo yükleniyor:', err);
    showOfflineBadge(true);
    // Burada demo CSV’yi tekrar kullanabilirsin
  }
}


function renderTable(){
  const tbody=document.querySelector('#dataTable tbody');
  tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    Object.keys(r).forEach(k=>{
      const td=document.createElement('td');
      td.textContent=r[k];
      tr.appendChild(td);
    });
    // Düzenle butonu
    const tdEdit=document.createElement('td');
    const btnEdit=document.createElement('button'); btnEdit.textContent='Düzenle';
    btnEdit.className='btn-edit'; btnEdit.addEventListener('click',()=>openEditModal(i));
    tdEdit.appendChild(btnEdit); tr.appendChild(tdEdit);
    // Sil butonu
    const tdDel=document.createElement('td');
    const btnDel=document.createElement('button'); btnDel.textContent='Sil';
    btnDel.className='btn-delete'; btnDel.addEventListener('click',()=>deleteRow(i));
    tdDel.appendChild(btnDel); tr.appendChild(tdDel);

    tbody.appendChild(tr);
  });
  // Başlık
  const thead=document.querySelector('#dataTable thead');
  thead.innerHTML='';
  const trHead=document.createElement('tr');
  Object.keys(rows[0]).forEach(k=>{const th=document.createElement('th'); th.textContent=k; trHead.appendChild(th);});
  trHead.appendChild(document.createElement('th')); // Düzenle
  trHead.appendChild(document.createElement('th')); // Sil
  thead.appendChild(trHead);
}

function openEditModal(index){
  currentEditRow=index;
  const r=rows[index];
  document.getElementById('editTarih').value=r.Tarih;
  document.getElementById('editVardiya').value=r.Vardiya;
  document.getElementById('editHat').value=r.Hat;
  document.getElementById('editAciklama').value=r.Açıklama;
  document.getElementById('editPersonel').value=r.Personel;
  document.getElementById('editKalite').value=r.KalitePersoneli;
  const modal=new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}

document.getElementById('saveEditBtn').addEventListener('click', async ()=>{
  const r = {
    tarih: document.getElementById('editTarih').value,
    vardiya: document.getElementById('editVardiya').value,
    hat: document.getElementById('editHat').value,
    aciklama: document.getElementById('editAciklama').value,
    personel: document.getElementById('editPersonel').value,
    kalitePersoneli: document.getElementById('editKalite').value
  };
  const fileInput=document.getElementById('editFotoBase64');
  if(fileInput.files.length>0){
    const file = fileInput.files[0];
    r.foto_base64 = await toBase64(file);
  }
  try{
    const res = await fetch(BACKEND_URL+"/api/duzenle",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({row:currentEditRow+2,yeni:r})
    });
    const data = await res.json();
    if(res.ok){ alert(data.mesaj); rows[currentEditRow]=r; renderTable(); }
    else alert(data.hata);
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
  }catch(e){ alert("Hata: "+e); }
});

function toBase64(file){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=err=>rej(err); r.readAsDataURL(file); });}

async function deleteRow(index){
  if(!confirm("Satırı silmek istediğinizden emin misiniz?")) return;
  try{
    const res = await fetch(BACKEND_URL+"/api/sil",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({row:index+2})
    });
    const data = await res.json();
    if(res.ok){ alert(data.mesaj); rows.splice(index,1); renderTable(); }
    else alert(data.hata);
  }catch(e){ alert("Hata: "+e); }
}
</script>
</body>
</html>
